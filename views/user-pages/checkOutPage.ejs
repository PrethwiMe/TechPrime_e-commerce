<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Checkout | TechCart</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
  <style>
    body { background-color: #121212; color: #f1f1f1; }
    .card { background: #fff; color: #000; border-radius: 10px; transition: 0.3s; }
    .card:hover { background-color: #f1f1f1; }
    .btn-success { background-color: #28a745; border: none; }
    .btn-success:hover { background-color: #218838; }
  </style>
</head>
<body>

  <%- include('partials/header') %>

  <div class="container py-4">
    <div class="row">
      <!-- Left: Cart -->
      <div class="col-lg-7 mb-4">
        <div class="card shadow-sm mb-4">
          <div class="card-header bg-dark text-white">
            <i class="bi bi-cart-fill me-2"></i> Your Cart
          </div>
          <ul class="list-group list-group-flush">
            <% if (cartItems && cartItems.length > 0) { %>
              <% cartItems.forEach(item => { %>
                <li class="list-group-item d-flex justify-content-between align-items-start">
                  <div class="d-flex">
                    <img src="<%= item.product?.images?.[0] || '/images/default-product.png' %>" 
                         class="img-thumbnail me-3" style="width:100px; height:100px; object-fit:cover;">
                    <div>
                      <strong><%= item.product?.name || 'Unknown Product' %></strong><br>
                      <small><%= item.variant?.processor %>, <%= item.variant?.ram %>, <%= item.variant?.storage %></small><br>
                      <small>Color: <%= item.variant?.color %></small>
                    </div>
                  </div>
                  <div class="text-end">
                    <span>â‚¹<%= item.variant?.price || 0 %></span><br>
                    <small>Qty: <%= item.quantity %></small><br>
                    <strong>â‚¹<%= (item.variant?.price || 0) * item.quantity %></strong>
                  </div>
                </li>
              <% }) %>
            <% } else { %>
              <li class="list-group-item">Your cart is empty.</li>
            <% } %>
          </ul>
        </div>

        <!-- Order Summary -->
        <div class="card shadow-sm">
          <div class="card-header bg-dark text-white">
            <i class="bi bi-receipt-cutoff me-2"></i> Order Summary
          </div>
          <div class="card-body">
            <p class="d-flex justify-content-between"><span>Subtotal:</span> <span>â‚¹<%= subtotal %></span></p>
            <p class="d-flex justify-content-between"><span>Tax:</span> <span>â‚¹<%= tax %></span></p>
            <p class="d-flex justify-content-between"><span>Delivery:</span> <span>â‚¹<%= deliveryCharge %></span></p>
            <hr>
            <h5 class="d-flex justify-content-between">
              <span>Total:</span> 
              <span class="text-success">â‚¹<%= total %></span>
            </h5>
            <div class="mt-3">
              <input type="text" id="couponCode" class="form-control mb-2" placeholder="Enter coupon code">
              <button class="btn btn-outline-primary w-100 mb-2" id="applyCouponBtn">
                <i class="bi bi-ticket-perforated-fill me-1"></i> Apply Coupon
              </button>
              <button class="btn btn-danger w-100" id="placeOrderBtn">
                <i class="bi bi-bag-check-fill me-1"></i> Place Order
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Right: Address + Payment -->
      <div class="col-lg-5 mb-4">
        <div class="card shadow-sm">
          <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
            <span><i class="bi bi-geo-alt-fill me-2"></i> Delivery Address</span>
            <button class="btn btn-sm btn-light" data-bs-toggle="modal" data-bs-target="#addAddressModal">+ Add Address</button>
          </div>
          <div class="card-body">
            <% if (addresses && addresses.length > 0) { %>
              <% addresses.forEach((address, idx) => { %>
                <div class="form-check mb-3">
                  <input class="form-check-input" type="radio" 
                         name="selectedAddress" id="address<%= idx %>" 
                         value='<%- JSON.stringify(address) %>' <%= idx===0 ? "checked" : "" %>>
                  <label class="form-check-label" for="address<%= idx %>">
                    <strong><%= address.fullName %></strong><br>
                    <%= address.line1 %>, <%= address.city %>, <%= address.state %> - <%= address.pincode %><br>
                    Phone: <%= address.phone %>
                  </label>
                </div>
              <% }) %>
            <% } else { %>
              <p class="text-muted">No addresses available. Please add one.</p>
            <% } %>
          </div>
        </div>

        <!-- Payment Methods -->
        <div class="card shadow-sm mt-4">
          <div class="card-header bg-secondary text-white">
            <i class="bi bi-credit-card-fill me-2"></i> Payment Methods
          </div>
          <div class="card-body d-flex justify-content-around">
            <div class="form-check text-center">
              <input class="form-check-input" type="radio" name="paymentMethod" id="cod" value="cod" checked>
              <label class="form-check-label d-block" for="cod">
                <i class="bi bi-cash-coin" style="font-size: 2.5rem; color: #28a745;"></i><br>
                Cash on Delivery
              </label>
            </div>
            <div class="form-check text-center">
              <input class="form-check-input" type="radio" name="paymentMethod" id="online" value="online">
              <label class="form-check-label d-block" for="online">
                <i class="bi bi-credit-card" style="font-size: 2.5rem; color: #0d6efd;"></i><br>
                Online Payment
              </label>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Order Success Modal -->
  <div class="modal fade" id="orderSuccessModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content text-center">
        <div class="modal-header bg-secondary text-white">
          <h5 class="modal-title">Order Success</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body p-4">
          <h3 class="text-success mb-3">ðŸŽ‰ Order Placed Successfully!</h3>
          <p>Your order has been confirmed. Thank you for shopping with TechCart!</p>
          <div class="d-flex justify-content-center gap-3 mt-3">
            <a href="/" class="btn btn-light"><i class="bi bi-house-door-fill me-2"></i> Home</a>
            <a href="/account/orders" class="btn btn-primary"><i class="bi bi-bag-check-fill me-2"></i> My Orders</a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.getElementById("placeOrderBtn").addEventListener("click", async () => {
      const selectedAddressRaw = document.querySelector('input[name="selectedAddress"]:checked')?.value;
      const selectedPayment = document.querySelector('input[name="paymentMethod"]:checked')?.value;

      if (!selectedAddressRaw) {
        Swal.fire("No address selected", "Please select a delivery address.", "warning");
        return;
      }
      if (!selectedPayment) {
        Swal.fire("No payment method", "Please choose a payment method.", "warning");
        return;
      }

      const selectedAddress = JSON.parse(selectedAddressRaw);

      // âœ… Convert cartItems into required format
      const items = <%- JSON.stringify(cartItems) %>.map(ci => ({
        productId: ci.product?._id || ci.productId,
        variantId: ci.variant?._id || ci.variantId,
        quantity: ci.quantity,
        price: ci.variant?.price || ci.price
      }));

      try {
        const res = await axios.post("/cart/checkout/order", {
          selectedAddress,
          paymentMethod: selectedPayment,
          items,
          subtotal: "<%= subtotal %>",
          tax: "<%= tax %>",
          deliveryCharge: "<%= deliveryCharge %>",
          total: "<%= total %>",
          couponCode: document.getElementById("couponCode").value.trim()
        });

        if (res.data.status === "success") {
          const orderModal = new bootstrap.Modal(document.getElementById("orderSuccessModal"));
          orderModal.show();
          confetti({ particleCount: 200, spread: 120, origin: { y: 0.6 } });
        } else {
          Swal.fire("Error", res.data.message || "Order failed", "error");
        }
      } catch (err) {
        Swal.fire("Error", "Something went wrong. Try again.", "error");
      }
    });

    document.getElementById("applyCouponBtn").addEventListener("click", () => {
      const code = document.getElementById("couponCode").value.trim();
      if (!code) return Swal.fire("Enter coupon", "Please enter a coupon code.", "info");
      Swal.fire("Coupon Applied", "Coupon discount applied successfully.", "success");
    });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
