<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Checkout | TechCart</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
  <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
  <style>
    /* Updated color scheme to match homepage - black/dark theme */
    body {
      background-color: #f8f9fa;
      color: #222;
      font-family: 'Segoe UI', sans-serif;
    }

    /* Card styling - white background with subtle shadow */
    .card {
      background: #fff;
      color: #222;
      border-radius: 12px;
      border: none;
      box-shadow: 0 3px 15px rgba(0, 0, 0, 0.05);
      transition: all 0.3s ease;
    }

    .card:hover {
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    }

    /* Header styling - black background matching homepage */
    .card-header {
      background-color: #000 !important;
      color: #fff !important;
      font-weight: 600;
      border-radius: 12px 12px 0 0;
      padding: 1.2rem;
    }

    /* Updated button styling - black buttons matching homepage */
    .btn-primary {
      background-color: #1a1a1a;
      border-color: #1a1a1a;
      color: #fff;
      font-weight: 500;
      transition: all 0.3s ease;
    }

    .btn-primary:hover {
      background-color: #333;
      border-color: #333;
      transform: translateY(-2px);
      color: #fff;
    }

    .btn-outline-primary {
      color: #000;
      border-color: #000;
      font-weight: 500;
      transition: all 0.3s ease;
    }

    .btn-outline-primary:hover {
      background-color: #000;
      border-color: #000;
      color: #fff;
      transform: translateY(-2px);
    }

    .btn-outline-secondary {
      color: #666;
      border-color: #ddd;
      font-weight: 500;
      transition: all 0.3s ease;
    }

    .btn-outline-secondary:hover {
      background-color: #f0f0f0;
      border-color: #bbb;
      color: #222;
      transform: translateY(-2px);
    }

    .btn-danger {
      background-color: #dc3545;
      border-color: #dc3545;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .btn-danger:hover {
      background-color: #c82333;
      border-color: #c82333;
      transform: translateY(-2px);
    }

    /* Form controls styling */
    .form-control {
      border-radius: 8px;
      border: 1px solid #ddd;
      padding: 0.7rem;
      transition: all 0.3s ease;
    }

    .form-control:focus {
      border-color: #000;
      box-shadow: 0 0 0 0.2rem rgba(0, 0, 0, 0.1);
    }

    /* Text styling - matching homepage aesthetics */
    .text-strike {
      text-decoration: line-through;
      color: #888;
      font-size: 0.9rem;
    }

    .text-success {
      color: #28a745 !important;
      font-weight: 600;
    }

    .list-group-item {
      border-color: #eee;
      transition: all 0.3s ease;
      background-color: #fff;
    }

    .list-group-item:hover {
      background-color: #f8f9fa;
    }

    /* Coupon table styling - matching modern design */
    .coupon-table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
    }

    .coupon-table thead {
      background: #1a1a1a;
    }

    .coupon-table thead th {
      color: white;
      font-weight: 600;
      text-transform: uppercase;
      font-size: 0.875rem;
      padding: 1rem;
      border: 1px solid #333;
      font-family: 'Segoe UI', sans-serif;
    }

    .coupon-table tbody td {
      padding: 1rem;
      color: #222;
      font-weight: 500;
      border: 1px solid #eee;
      font-family: 'Segoe UI', sans-serif;
    }

    .coupon-table tbody tr:hover {
      background-color: #f8f9fa;
    }

    /* Payment method icons - simplified styling */
    .form-check .bi {
      font-size: 2.5rem;
      color: #000;
      transition: transform 0.3s ease;
    }

    .form-check:hover .bi {
      transform: scale(1.1);
    }

    /* Modal styling */
    .modal-content {
      border-radius: 12px;
      border: none;
    }

    .modal-header {
      background-color: #1a1a1a;
      color: #fff;
      border-radius: 12px 12px 0 0;
    }

    .btn-close-white {
      filter: brightness(0) invert(1);
    }

    /* Image styling in cart items */
    .img-thumbnail {
      border-radius: 8px;
      border: 1px solid #eee;
      transition: transform 0.3s ease;
    }

    .img-thumbnail:hover {
      transform: scale(1.05);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }

    /* Section title styling */
    .order-summary-title {
      font-size: 1.2rem;
      font-weight: 700;
      color: #000;
      border-left: 5px solid #000;
      padding-left: 12px;
      margin-bottom: 1.5rem;
    }

    h5 {
      color: #000;
      font-weight: 700;
    }

    p span {
      font-weight: 500;
    }

    /* Gap utilities for spacing */
    .gap-3 {
      gap: 1rem;
    }

    .ms-1 {
      margin-left: 0.25rem;
    }

    @media (max-width: 768px) {
      .card {
        margin-bottom: 1.5rem;
      }

      .btn-outline-primary,
      .btn-outline-secondary {
        width: 100% !important;
        margin-bottom: 0.5rem;
      }
    }
  </style>
</head>
<body>

  <%- include('partials/header') %>

  <div class="container py-5">
    <div class="row g-4">
      <!-- Left: Cart -->
      <div class="col-lg-7">
        <div class="card shadow-sm mb-4">
          <div class="card-header">
            <i class="bi bi-cart-fill me-2"></i> Your Cart
          </div>
          <ul class="list-group list-group-flush" id="cartItems">
            <% if (cartItems && cartItems.length > 0) { %>
              <% cartItems.forEach(item => { %>
                <li class="list-group-item d-flex justify-content-between align-items-start" data-item-id="<%= item.product?._id || item.productId %>">
                  <div class="d-flex">
                    <img src="<%= item.product?.images?.[0] || '/images/default-product.png' %>" 
                         class="img-thumbnail me-3" style="width:100px; height:100px; object-fit:cover;">
                    <div>
                      <strong><%= item.product?.name || 'Unknown Product' %></strong><br>
                      <small class="text-muted"><%= item.variant?.processor %>, <%= item.variant?.ram %>, <%= item.variant?.storage %></small><br>
                      <small class="text-muted">Color: <%= item.variant?.color %></small>
                    </div>
                  </div>
                  <div class="text-end">
                    <% if (item.appliedOffer && item.discountedPrice < item.originalPrice) { %>
                      <span class="text-strike">â‚¹<%= item.originalPrice?.toFixed(2) %></span><br>
                      <span class="text-success">â‚¹<%= item.discountedPrice.toFixed(2) %></span><br>
                    <% } else { %>
                      <span class="fw-bold">â‚¹<%= item.originalPrice?.toFixed(2) %></span><br>
                    <% } %>
                    <small class="text-muted">Qty: <%= item.quantity %></small><br>
                    <strong>â‚¹<%= (item.discountedPrice * item.quantity).toFixed(2) %></strong>
                  </div>
                </li>
              <% }) %>
            <% } else { %>
              <li class="list-group-item text-muted">Your cart is empty.</li>
            <% } %>
          </ul>
        </div>

        <!-- Order Summary -->
        <div class="card shadow-sm">
          <div class="card-header">
            <i class="bi bi-receipt-cutoff me-2"></i> Order Summary
          </div>
          <div class="card-body">
            <p class="d-flex justify-content-between"><span>Subtotal:</span> <span id="subtotal" class="fw-bold">â‚¹<%= subtotal.toFixed(2) %></span></p>
            <% if (typeof totalDiscount !== 'undefined' && totalDiscount > 0) { %>
            <p class="d-flex justify-content-between text-success" id="discountRow">
              <span>Discount:</span> 
              <span id="discountAmount" class="fw-bold">-â‚¹<%= totalDiscount.toFixed(2) %></span>
            </p>
            <% } %>
            <p class="d-flex justify-content-between"><span>Delivery:</span> <span id="deliveryCharge" class="fw-bold">â‚¹<%= deliveryCharge.toFixed(2) %></span></p>
            <hr class="my-3">
            <h5 class="d-flex justify-content-between mb-3">
              <span>Total:</span> 
              <span class="text-success" id="total">â‚¹<%= total.toFixed(2) %></span>
            </h5>
            <div class="mt-4">
              <input type="text" id="couponCode" class="form-control mb-2" placeholder="Enter coupon code">
              <div class="d-flex gap-2 mb-3" id="couponButtons">
                <button class="btn btn-outline-primary flex-grow-1" id="applyCouponBtn">
                  <i class="bi bi-ticket-perforated-fill me-1"></i> Apply Coupon
                </button>
                <% if (typeof totalDiscount !== 'undefined' && totalDiscount > 0) { %>
                <button class="btn btn-outline-danger" id="removeCouponBtn" style="min-width: auto; padding: 0.375rem 0.75rem;">
                  <i class="bi bi-x-circle me-1"></i>Remove
                </button>
                <% } %>
                <button class="btn btn-outline-secondary flex-grow-1" id="viewCouponsBtn" data-bs-toggle="modal" data-bs-target="#viewCouponsModal">
                  <i class="bi bi-ticket-fill me-1"></i> View Coupons
                </button>
              </div>
              <button class="btn btn-danger w-100" id="placeOrderBtn">
                <i class="bi bi-bag-check-fill me-2"></i> Place Order
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Right: Address + Payment -->
      <div class="col-lg-5">
        <div class="card shadow-sm mb-4">
          <div class="card-header d-flex justify-content-between align-items-center">
            <span><i class="bi bi-geo-alt-fill me-2"></i> Delivery Address</span>
            <button class="btn btn-sm btn-light" data-bs-toggle="modal" data-bs-target="#addAddressModal">+ Add</button>
          </div>
          <div class="card-body" id="userAddresses" data-addresses='<%- JSON.stringify(addresses || []) %>'>
            <% if (addresses && addresses.length > 0) { %>
              <% addresses.forEach((address, idx) => { %>
                <div class="form-check mb-3">
                  <input class="form-check-input" type="radio" 
                         name="selectedAddress" id="address<%= idx %>" 
                         value='<%- JSON.stringify(address) %>' <%= idx===0 ? "checked" : "" %>>
                  <label class="form-check-label w-100" for="address<%= idx %>">
                    <strong><%= address.fullName %></strong><br>
                    <small class="text-muted"><%= address.line1 %>, <%= address.city %>, <%= address.state %> - <%= address.pincode %></small><br>
                    <small class="text-muted">Phone: <%= address.phone %></small>
                  </label>
                </div>
              <% }) %>
            <% } else { %>
              <p class="text-muted mb-0">No addresses available. Please add one.</p>
            <% } %>
          </div>
        </div>

        <!-- Payment Methods -->
        <div class="card shadow-sm">
          <div class="card-header">
            <i class="bi bi-credit-card-fill me-2"></i> Payment Methods
          </div>
          <div class="card-body">
            <div class="d-flex flex-column gap-3">
              <div class="form-check d-flex align-items-center p-3 border rounded-2" style="background-color: #f8f9fa;">
                <input class="form-check-input me-3" type="radio" name="paymentMethod" id="cod" value="cod" checked>
                <label class="form-check-label flex-grow-1 mb-0" for="cod">
                  <i class="bi bi-cash-coin me-2"></i>
                  <strong>Cash on Delivery</strong><br>
                  <small class="text-muted">Pay when you receive</small>
                </label>
              </div>
              <div class="form-check d-flex align-items-center p-3 border rounded-2" style="background-color: #f8f9fa;">
                <input class="form-check-input me-3" type="radio" name="paymentMethod" id="online" value="online">
                <label class="form-check-label flex-grow-1 mb-0" for="online">
                  <i class="bi bi-credit-card me-2"></i>
                  <strong>Online Payment</strong><br>
                  <small class="text-muted">Razorpay secure payment</small>
                </label>
              </div>
              <div class="form-check d-flex align-items-center p-3 border rounded-2" style="background-color: #f8f9fa;">
                <input class="form-check-input me-3" type="radio" name="paymentMethod" id="wallet" value="wallet">
                <label class="form-check-label flex-grow-1 mb-0" for="wallet">
                  <i class="bi bi-wallet2 me-2"></i>
                  <strong>Pay with Wallet</strong><br>
                  <small class="text-muted">Use your wallet balance</small>
                </label>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Order Success Modal -->
  <div class="modal fade" id="orderSuccessModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-check-circle-fill me-2" style="color: #28a745;"></i>Order Success</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body p-4 text-center">
          <h3 class="text-success mb-3 animate__animated animate__bounceIn">ðŸŽ‰ Order Placed Successfully!</h3>
          <p class="text-muted">Your order has been confirmed. Thank you for shopping with TechCart!</p>
          <div class="d-flex justify-content-center gap-3 mt-4">
            <a href="/" class="btn btn-outline-primary"><i class="bi bi-house-door-fill me-2"></i> Home</a>
            <a href="/account/orders" class="btn btn-primary"><i class="bi bi-bag-check-fill me-2"></i> My Orders</a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Address Modal -->
  <div class="modal fade" id="addAddressModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <form id="addAddressForm">
          <div class="modal-header">
            <h5 class="modal-title">Add New Address</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label">Full Name</label>
              <input type="text" class="form-control" name="fullName"   />
            </div>
            <div class="mb-3">
              <label class="form-label">Phone</label>
              <input type="text" class="form-control" name="phone"   />
            </div>
            <div class="mb-3">
              <label class="form-label">Address Line 1</label>
              <input type="text" class="form-control" name="line1"   />
            </div>
            <div class="mb-3">
              <label class="form-label">City</label>
              <input type="text" class="form-control" name="city"   />
            </div>
            <div class="mb-3">
              <label class="form-label">State</label>
              <input type="text" class="form-control" name="state"   />
            </div>
            <div class="mb-3">
              <label class="form-label">Pincode</label>
              <input type="text" class="form-control" name="pincode"   placeholder="Enter 6-digit PIN code" maxlength="6" />
            </div>
          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-primary">Add Address</button>
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- View Coupons Modal -->
  <div class="modal fade" id="viewCouponsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-ticket-fill me-2"></i> Available Coupons</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <table class="coupon-table">
            <thead>
              <tr>
                <th>Code</th>
                <th>Discount</th>
                <th>Valid Until</th>
                <th>Min Purchase</th>
              </tr>
            </thead>
            <tbody id="couponTableBody">
              <% if (coupon && Array.isArray(coupon) && coupon.length > 0) { %>
                <% coupon.forEach(c => { %>
                  <tr>
                    <td><strong><%= c.code %></strong></td>
                    <td><strong><%= c.discount %>%</strong></td>
                    <td><%= c.validUntil ? new Date(c.validUntil).toISOString().split('T')[0] : 'No Expiry' %></td>
                    <td>â‚¹<%= c.minimumPurchase.toFixed(2) %></td>
                  </tr>
                <% }) %>
              <% } else { %>
                <tr><td colspan="4" class="text-center text-muted">No coupons available.</td></tr>
              <% } %>
            </tbody>
          </table>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    let cartItems = <%- JSON.stringify(cartItems || []) %>.map(ci => ({
      productId: ci.product?._id || ci.productId,
      variantId: ci.variant?._id || ci.variantId,
      quantity: ci.quantity,
      price: ci.variant?.price || ci.price,
      originalPrice: ci.originalPrice || ci.variant?.price || ci.price,
      product: ci.product,
      variant: ci.variant,
      appliedOffer: ci.appliedOffer || false,
      discountedPrice: ci.discountedPrice || ci.variant?.price || ci.price
    }));

    function getCurrentOrderValues() {
      return {
        subtotal: parseFloat(document.getElementById("subtotal").textContent.replace("â‚¹", "")),
        total: parseFloat(document.getElementById("total").textContent.replace("â‚¹", ""))
      };
    }

    // Event delegation for remove button (handles both initial and dynamic)
    document.addEventListener('click', function(e) {
      if (e.target.id === 'removeCouponBtn' || e.target.closest('#removeCouponBtn')) {
        e.preventDefault();
window.location.reload();
      }
    });

    document.getElementById("applyCouponBtn").addEventListener("click", async () => {
      const code = document.getElementById("couponCode").value.trim();
      if (!code) {
        Swal.fire("Enter coupon", "Please enter a coupon code.", "info");
        return;
      }

      try {
        const orderValues = getCurrentOrderValues();
        const response = await axios.post("/checkout/apply-coupon", {
          code,
          subtotal: orderValues.subtotal,
          items: cartItems
        });

        if (response.data.success) {
          cartItems = response.data.updatedItems;

          const buttonContainer = document.getElementById('couponButtons');

          if (response.data.discount > 0) {
            let discountRow = document.getElementById("discountRow");
            if (!discountRow) {
              const newDiscountRow = document.createElement("p");
              newDiscountRow.className = "d-flex justify-content-between text-success";
              newDiscountRow.id = "discountRow";
              newDiscountRow.innerHTML = `
                <span>Discount:</span> 
                <span id="discountAmount" class="fw-bold">-â‚¹${response.data.discount.toFixed(2)}</span>
              `;
              // Insert after subtotal row
              const subtotalRow = document.querySelector('#subtotal').closest('p');
              subtotalRow.parentNode.insertBefore(newDiscountRow, subtotalRow.nextSibling);
            } else {
              document.getElementById("discountAmount").textContent = `-â‚¹${response.data.discount.toFixed(2)}`;
            }

            // Add or update remove button
            let removeBtn = document.getElementById("removeCouponBtn");
            if (!removeBtn) {
              removeBtn = document.createElement("button");
              removeBtn.className = "btn btn-outline-danger";
              removeBtn.id = "removeCouponBtn";
              removeBtn.style.minWidth = "auto";
              removeBtn.style.padding = "0.375rem 0.75rem";
              removeBtn.innerHTML = `
                <i class="bi bi-x-circle me-1"></i>Remove
              `;
              // Insert after apply button
              const applyBtn = document.getElementById("applyCouponBtn");
              buttonContainer.insertBefore(removeBtn, applyBtn.nextSibling);
            }
          } else {
            // Remove discount row and button if discount is 0
            const discountRow = document.getElementById("discountRow");
            if (discountRow) {
              discountRow.remove();
            }
            const removeBtn = document.getElementById("removeCouponBtn");
          
          }

          document.getElementById("deliveryCharge").textContent = `â‚¹${response.data.deliveryCharge.toFixed(2)}`;
          document.getElementById("total").textContent = `â‚¹${response.data.discountedTotal.toFixed(2)}`;

          Swal.fire("Success", response.data.message, "success");
        } else {
          Swal.fire("Error", response.data.message, "error");
        }
      } catch (error) {
        Swal.fire("Error", error.response?.data?.message || "Failed to apply coupon", "error");
      }
    });

    document.getElementById("placeOrderBtn").addEventListener("click", async () => {
      const selectedAddressRaw = document.querySelector('input[name="selectedAddress"]:checked')?.value;
      const selectedPayment = document.querySelector('input[name="paymentMethod"]:checked')?.value;

      if (!selectedAddressRaw) {
        Swal.fire("No address selected", "Please select a delivery address.", "warning");
        return;
      }
      if (!selectedPayment) {
        Swal.fire("No payment method", "Please choose a payment method.", "warning");
        return;
      }

      const selectedAddress = JSON.parse(selectedAddressRaw);
      const orderValues = getCurrentOrderValues();
      
      const orderPayload = {
        selectedAddress,
        paymentMethod: selectedPayment,
        items: cartItems,
        subtotal: orderValues.subtotal,
        deliveryCharge: parseFloat(document.getElementById("deliveryCharge").textContent.replace("â‚¹", "")),
        total: orderValues.total,
        amount: Math.round(orderValues.total * 100),
        couponCode: document.getElementById("couponCode").value.trim() || null
      };

      console.log("Order Payload:", orderPayload);

      if (selectedPayment === "cod" || selectedPayment === "wallet") {
        try {
          const res = await axios.post("/cart/checkout/order", orderPayload);
          if (res.data.status === "success") {
            new bootstrap.Modal(document.getElementById("orderSuccessModal")).show();
            confetti({ particleCount: 200, spread: 120, origin: { y: 0.6 } });
          } else {
            Swal.fire("Error", res.data.message || "Order failed", "error");
          }
        } catch (error) {
          Swal.fire("Error", error.response?.data?.message || "Something went wrong. Try again.", "error");
        }
      } else {
        try {
          const orderRes = await axios.post("/create-order", orderPayload);
          const { id: razorpayOrderId, amount, currency, dbOrderId } = orderRes.data;

          const options = {
            key: "<%= process.env.RAZORPAY_KEY_ID %>",
            amount: amount,
            currency: currency,
            order_id: razorpayOrderId,
            name: "TechCart",
            description: "Order Payment",
            handler: async function (response) {
              try {
                const verifyPayload = {
                  ...orderPayload,
                  paymentMethod: "online",
                  razorpayPaymentId: response.razorpay_payment_id,
                  razorpayOrderId: response.razorpay_order_id,
                  razorpaySignature: response.razorpay_signature,
                  dbOrderId: dbOrderId
                };

                console.log("Verify Payload:", verifyPayload);

                const confirm = await axios.post("/order/verifyPayment", verifyPayload);

                if (confirm.data.success) {
                  new bootstrap.Modal(document.getElementById("orderSuccessModal")).show();
                  confetti({ particleCount: 200, spread: 120, origin: { y: 0.6 } });
                } else {
                  Swal.fire("Error", confirm.data.message || "Order confirmation failed", "error");
                }
              } catch (error) {
                console.error("Payment verification error:", error);
                Swal.fire("Error", error.response?.data?.message || "Payment verification failed", "error");
              }
            },
            prefill: {
              name: selectedAddress.fullName,
              contact: selectedAddress.phone
            },
            theme: { color: "#000" }
          };
          new Razorpay(options).open();
        } catch (error) {
          console.error("Payment initiation error:", error);
          Swal.fire("Error", error.response?.data?.message || "Could not start payment", "error");
        }
      }
    });

    async function fetchAddressDetails(pincode) {
      try {
        const response = await fetch(`https://api.postalpincode.in/pincode/${pincode}`);
        if (!response.ok) {
          throw new Error('API request failed');
        }
        const data = await response.json();
        if (data && data[0] && data[0].Status === 'Success' && data[0].PostOffice.length > 0) {
          const postOffice = data[0].PostOffice[0];
          return {
            city: postOffice.District,
            state: postOffice.State
          };
        }
      } catch (error) {
        console.error('Error fetching address details:', error);
      }
      return null;
    }

    const addAddressForm = document.getElementById('addAddressForm');
    addAddressForm.addEventListener('submit', function (e) {
      e.preventDefault();
      const formData = new FormData(addAddressForm);
      const data = Object.fromEntries(formData.entries());

      axios.post('/account/addAddress', data)
        .then(response => {
          Swal.fire({
            icon: 'success',
            title: 'Success',
            text: response.data.message,
            timer: 2000,
            showConfirmButton: false,
          }).then(() => location.reload());
        })
        .catch(error => {
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: error.response?.data?.message || 'Something went wrong!',
          });
        });
    });

    const addPincodeInput = addAddressForm.querySelector('input[name="pincode"]');
    addPincodeInput.addEventListener('blur', async function() {
      const pincode = this.value.trim();
      if (pincode.length === 6 && /^\d{6}$/.test(pincode)) {
        const details = await fetchAddressDetails(pincode);
        if (details) {
          addAddressForm.querySelector('input[name="city"]').value = details.city || '';
          addAddressForm.querySelector('input[name="state"]').value = details.state || '';
        } else {
          console.warn('No address details found for PIN code:', pincode);
        }
      }
    });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>

<%- include('partials/footer') %>