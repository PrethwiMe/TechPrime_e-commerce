<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TechCart - Products</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    body { background-color: #f8f9fa; font-family: 'Segoe UI', sans-serif; display: flex; flex-direction: column; min-height: 100vh; }
    main { flex: 1; }

    .filters { border: 1px solid #ddd; padding: 25px; border-radius: 10px; background-color: #fff; margin-bottom: 30px; }
    .filters h5 { font-weight: 600; margin-bottom: 20px; }
    .filters label { display: block; margin-bottom: 12px; cursor: pointer; font-weight: 500; }

    .sort-bar { display: flex; align-items: center; gap: 20px; margin-bottom: 30px; flex-wrap: wrap; }
    .sort-bar a { text-decoration: none; color: #555; font-weight: 500; transition: color 0.2s; cursor: pointer; }
    .sort-bar a:hover, .sort-bar .active { color: #000; font-weight: 600; }

    .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 25px; }
    .product-card { background-color: #fff; border-radius: 12px; overflow: hidden; box-shadow: 0 3px 12px rgba(0,0,0,0.05); transition: all 0.3s ease; text-align: center; padding-bottom: 15px; }
    .product-card:hover { transform: translateY(-6px); box-shadow: 0 8px 25px rgba(0,0,0,0.12); }
    .product-card img { width: 100%; height: 200px; object-fit: contain; margin-top: 15px; }
    .product-card h6 { font-size: 1rem; margin: 12px 0 6px; font-weight: 600; }
    .price { font-weight: bold; color: #dc3545; font-size: 1.1rem; }
    .old-price { text-decoration: line-through; color: gray; font-size: 0.85rem; margin-left: 6px; }
    .star { color: #ffc107; margin: 5px 0; }
    .btn-custom { background-color: #1a1a1a; color: #fff; border: none; font-weight: 500; padding: 8px 16px; border-radius: 6px; font-size: 0.9rem; transition: all 0.3s ease; }
    .btn-custom:hover { background-color: #333; transform: translateY(-2px); }
    .btn-custom.wishlist { padding: 8px 12px; font-size: 1.2rem; }

    .pagination { display: flex; justify-content: center; margin-top: 40px; gap: 8px; }
    .pagination .page-link { color: #1a1a1a; padding: 8px 14px; border: 1px solid #ddd; border-radius: 6px; }
    .pagination .page-item.active .page-link { background-color: #1a1a1a; border-color: #1a1a1a; color: #fff; }
  </style>
</head>
<body>
  <%- include('partials/header') %>

  <main class="container my-5">
    <nav aria-label="breadcrumb" class="mb-4">
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/">Home</a></li>
        <% if (query && query.trim() !== '') { %>
          <li class="breadcrumb-item active">Search: "<%= query %>"</li>
        <% } else { %>
          <li class="breadcrumb-item active">All Products</li>
        <% } %>
      </ol>
    </nav>

    <div class="row">
      <!-- FILTERS -->
      <div class="col-lg-3">
        <div class="filters">
          <h5>Filters</h5>

          <div class="mb-4">
            <strong>Categories</strong>
            <% categories.forEach(cat => { %>
              <label class="d-block mt-2">
                <input type="checkbox" class="filter-category" value="<%= cat._id %>"> <%= cat.name %>
              </label>
            <% }) %>
          </div>

          <div>
            <strong>Price Range</strong>
            <div class="d-flex gap-2 mt-2">
              <input type="number" id="minPrice" class="form-control" placeholder="Min ₹">
              <input type="number" id="maxPrice" class="form-control" placeholder="Max ₹">
            </div>
            <button id="applyPriceFilter" class="btn btn-dark btn-sm w-100 mt-2">Apply</button>
          </div>
        </div>
      </div>

      <!-- PRODUCTS -->
      <div class="col-lg-9">
        <div class="mb-3">
          <a href="/" class="btn btn-secondary btn-sm">&larr; Back to Home</a>
        </div>

        <div class="sort-bar">
          <span>Sort By:</span>
          <a class="sort-link active" data-sort="popularity">Popularity</a>
          <a class="sort-link" data-sort="newest">Newest First</a>
          <a class="sort-link" data-sort="low-high">Price: Low → High</a>
          <a class="sort-link" data-sort="high-low">Price: High → Low</a>
          <a class="sort-link" data-sort="a-z">Name A-Z</a>
          <a class="sort-link" data-sort="z-a">Name Z-A</a>
        </div>

        <div class="product-grid" id="product-grid"></div>
        <ul class="pagination" id="pagination"></ul>
      </div>
    </div>
  </main>

  <%- include('partials/footer') %>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const grid = document.getElementById("product-grid");
      const pagination = document.getElementById("pagination");
      const sortLinks = document.querySelectorAll(".sort-link");
      const categoryCheckboxes = document.querySelectorAll(".filter-category");
      const minPriceInput = document.getElementById("minPrice");
      const maxPriceInput = document.getElementById("maxPrice");
      const applyPriceBtn = document.getElementById("applyPriceFilter");
      const searchBox = document.getElementById("searchBox");

      // Check if user is logged in (from EJS)
      const isLoggedIn = <%= user ? 'true' : 'false' %>;

      let filters = {
        sort: "popularity",
        categories: [],
        minPrice: null,
        maxPrice: null,
        page: 1,
        limit: 6,
        searchKey: "<%= query || '' %>".trim()
      };

      const postData = async (url, data) => {
        const res = await fetch(url, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data)
        });
        return res.json();
      };

      const renderProducts = (products) => {
        if (!products || products.length === 0) {
          grid.innerHTML = `<p class="text-center text-muted fs-5">No products found.</p>`;
          return;
        }

        grid.innerHTML = products.map(p => `
          <div class="product-card">
            <a href="/all-product/product-details/${p._id}" class="text-decoration-none text-dark">
              <img src="${p.images?.[0] || '/images/default.png'}" alt="${p.name}" />
              <h6 class="px-3">${p.name}</h6>
              <div class="px-3">
                <span class="price">₹${p.fullProduct?.[0]?.price || p.originalPrice || 0}</span>
                ${p.originalPrice && p.fullProduct?.[0]?.price < p.originalPrice 
                  ? `<span class="old-price">₹${p.originalPrice}</span>` : ''}
              </div>
              <div class="star">★★★★★</div>
            </a>
            <div class="mt-2 d-flex justify-content-center gap-2 px-3">
              <button class="btn-custom add-to-cart"
                data-id="${p._id}"
                data-variant="${p.fullProduct?.[0]?._id || ''}"
                data-name="${p.name}">Add to Cart</button>
              <button class="btn-custom wishlist add-to-wishlist"
                data-id="${p._id}"
                data-name="${p.name}">♥</button>
            </div>
          </div>
        `).join("");

        bindCartWishlistButtons();
      };

      const renderPagination = (totalPages) => {
        pagination.innerHTML = "";
        if (totalPages <= 1) return;

        const createPageItem = (text, page, disabled = false) => {
          const li = document.createElement("li");
          li.className = `page-item ${disabled ? 'disabled' : ''} ${page === filters.page ? 'active' : ''}`;
          li.innerHTML = `<span class="page-link">${text}</span>`;
          if (!disabled && page !== filters.page) {
            li.addEventListener("click", () => goToPage(page));
          }
          return li;
        };

        pagination.appendChild(createPageItem("Previous", filters.page - 1, filters.page === 1));
        for (let i = 1; i <= totalPages; i++) {
          pagination.appendChild(createPageItem(i, i));
        }
        pagination.appendChild(createPageItem("Next", filters.page + 1, filters.page === totalPages));
      };

      const goToPage = (page) => {
        filters.page = page;
        fetchProducts();
      };

      const fetchProducts = async () => {
        if (searchBox) filters.searchKey = searchBox.value.trim();

        try {
          const res = await fetch("/search/data", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(filters)
          });
          const data = await res.json();
          renderProducts(data.products);
          renderPagination(data.totalPages || 1);
        } catch (err) {
          grid.innerHTML = `<p class="text-danger text-center">Error loading products.</p>`;
        }
      };

      // Main Fix: Smart Cart & Wishlist (No "Login to continue" for logged-in users)
      const bindCartWishlistButtons = () => {
        document.querySelectorAll(".add-to-cart, .add-to-wishlist").forEach(btn => {
          btn.onclick = async () => {
            const isCart = btn.classList.contains("add-to-cart");
            const payload = isCart
              ? { productId: btn.dataset.id, variantId: btn.dataset.variant, productName: btn.dataset.name }
              : { productId: btn.dataset.id, productName: btn.dataset.name };

            const endpoint = isCart ? "/cart/add" : "/wishlist";

            try {
              const res = await postData(endpoint, payload);

              if (res.success) {
                if (isCart) {
                  Swal.fire({
                    icon: "success",
                    title: "Added to Cart!",
                    text: res.message || `${btn.dataset.name} added successfully.`,
                    showCancelButton: true,
                    confirmButtonText: "Go to Cart",
                    cancelButtonText: "Continue Shopping"
                  }).then(r => r.isConfirmed && (location.href = "/cart"));
                } else {
                  Swal.fire({
                    icon: "success",
                    title: "Added to Wishlist!",
                    text: res.message || "Saved for later!",
                    timer: 1500,
                    showConfirmButton: false
                  });
                }
                return;
              }

              // Only show login prompt if NOT logged in
              if (res.loginRequired && !isLoggedIn) {
                Swal.fire({
                  icon: "warning",
                  title: "Login Required",
                  text: "Please login to add items to cart or wishlist.",
                  confirmButtonText: "Login Now"
                }).then(r => r.isConfirmed && (location.href = "/login"));
                return;
              }

              // Other errors
              Swal.fire({
                icon: "info",
                title: isCart ? "Not Added to Cart" : "Not Added to Wishlist",
                text: res.message || "Something went wrong."
              });

            } catch (err) {
              if (!isLoggedIn) {
                Swal.fire({
                  icon: "warning",
                  title: "Login Required",
                  text: "You need to be logged in.",
                  confirmButtonText: "Login"
                }).then(r => r.isConfirmed && (location.href = "/login"));
              } else {
                Swal.fire("Error", "Please try again later.", "error");
              }
            }
          };
        });
      };

      // Event Listeners
      sortLinks.forEach(link => {
        link.onclick = (e) => {
          e.preventDefault();
          sortLinks.forEach(l => l.classList.remove("active"));
          link.classList.add("active");
          filters.sort = link.dataset.sort;
          filters.page = 1;
          fetchProducts();
        };
      });

      categoryCheckboxes.forEach(cb => {
        cb.onchange = () => {
          filters.categories = Array.from(categoryCheckboxes)
            .filter(c => c.checked)
            .map(c => c.value);
          filters.page = 1;
          fetchProducts();
        };
      });

      applyPriceBtn.onclick = () => {
        filters.minPrice = minPriceInput.value ? Number(minPriceInput.value) : null;
        filters.maxPrice = maxPriceInput.value ? Number(maxPriceInput.value) : null;
        filters.page = 1;
        fetchProducts();
      };

      // Initial Load
      fetchProducts();
    });
  </script>
</body>
</html>