<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title><%= product && product.name ? (typeof product.name === 'string' ? product.name.replace(/</g, '&lt;').replace(/>/g, '&gt;') : 'Product') : 'Product Details' %> | TechCart</title>
  <link rel="icon" href="/images/favicon.ico" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body { background-color: #121212; color: #eaeaea; font-family: 'Segoe UI', sans-serif; }
    .main-img { width: 100%; height: 420px; object-fit: contain; border-radius: 12px; box-shadow: 0 5px 25px rgba(0,0,0,0.4); margin-bottom: 20px; background: #fff; padding: 10px; }
    .thumbs img { height: 85px; object-fit: contain; border-radius: 8px; cursor: pointer; margin-right: 12px; transition: all 0.3s ease; background: #fff; padding: 5px; }
    .thumbs img:hover { transform: scale(1.05); box-shadow: 0 4px 12px rgba(0,0,0,0.35); }
    .zoom-container { 
      position: relative; 
      overflow: hidden; 
      border-radius: 12px; 
      box-shadow: 0 5px 25px rgba(0,0,0,0.4); 
      margin-bottom: 20px; 
      background: #fff; 
      padding: 10px; 
      height: 420px; 
      background-size: 100% 100%; 
      background-position: center; 
      transition: background-size 0.2s ease; 
    }
    .zoom-container img { 
      width: 100%; 
      height: 100%; 
      object-fit: contain; 
      transition: opacity 0.15s ease; 
      border-radius: 8px; 
      background: #fff; 
      position: relative; 
      z-index: 2; 
    }
    .zoom-container::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background: #f0f0f0; /* Light gray placeholder */
      opacity: 0;
      transition: opacity 0.15s ease;
      z-index: 1;
    }
    .zoom-container.loading::before { opacity: 1; } /* Show during load */
    .zoom-container:hover img { 
      opacity: 0; 
      transition: opacity 0.15s ease; 
    }
    .zoom-container:hover { 
      background-repeat: no-repeat; 
      background-size: 150% 150%; 
      cursor: zoom-in;
      transition: background-size 0.2s ease;
    }
    .scroll-container { display: flex; gap: 20px; overflow-x: auto; scroll-behavior: smooth; padding-bottom: 15px; margin-bottom: 25px; }
    .slide-card { min-width: 220px; flex: 0 0 auto; border-radius: 12px; background: #fff; color: #000; text-align: center; padding: 18px; border: 1px solid #ddd; transition: all 0.3s ease; cursor: pointer; }
    .slide-card img { height: 150px; object-fit: contain; margin-bottom: 12px; transition: transform 0.3s ease; }
    .slide-card p { font-weight: 600; margin-bottom: 5px; }
    .slide-card span { color: #666; font-weight: 700; }
    .slide-card:hover { transform: translateY(-8px) scale(1.02); box-shadow: 0 8px 20px rgba(0,0,0,0.25), 0 0 10px rgba(100,150,255,0.3); border-color: #ccc; }
    .btn-dark-custom { background-color: #000; color: #fff; border-radius: 8px; padding: 10px 20px; font-weight: 500; border: 1px solid #333; transition: all 0.3s ease; }
    .btn-dark-custom:hover { background-color: #fff; color: #000; border: 1px solid #000; transform: translateY(-2px); }
    .btn-light-custom { background-color: #fff; color: #000; border-radius: 8px; padding: 10px 20px; font-weight: 500; border: 1px solid #ccc; transition: all 0.3s ease; }
    .btn-light-custom:hover { background-color: #000; color: #fff; border: 1px solid #000; transform: translateY(-2px); }
    .variant-card { border: 1px solid #ddd; border-radius: 12px; padding: 15px; margin-bottom: 15px; background: #fff; color: #000; transition: all 0.3s ease; cursor: pointer; }
    .variant-card:hover { border-color: #4682b4; box-shadow: 0 6px 20px rgba(70,130,180,0.25); transform: translateY(-3px); }
    .variant-card.active { border-color: #4682b4; box-shadow: 0 6px 20px rgba(70,130,180,0.35); }
    .section-title { font-size: 1.5rem; font-weight: 700; border-left: 5px solid #4682b4; padding-left: 12px; margin-bottom: 20px; }
    .review-card { background: #1e1e1e; color: #eee; transition: all 0.3s ease; }
    .review-card.expanded { background: #2e2e50; color: #fff; }
    .read-more { color: #4682b4; cursor: pointer; font-weight: 500; }
    .breadcrumb { background: transparent; margin-bottom: 1rem; }
    .breadcrumb-item a { color: #16aed4; text-decoration: none; transition: color 0.3s; }
    .breadcrumb-item a:hover { color: #fff; }
    .breadcrumb-item.active { color: #2b16c9; font-weight: 600; }
  </style>
</head>
<body>
  <%- include('partials/header') %>
  <nav aria-label="breadcrumb" class="mt-4 mb-4">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="/">Home</a></li>
      <li class="breadcrumb-item"><a href="/search">All Products</a></li>
      <li class="breadcrumb-item active" aria-current="page"><%= product && product.name ? (typeof product.name === 'string' ? product.name.replace(/</g, '&lt;').replace(/>/g, '&gt;') : 'Product') : 'Product' %></li>
    </ol>
  </nav>

  <div class="container my-5">
    <div class="row g-5">
      <!-- Product Gallery -->
      <div class="col-lg-6">
        <div id="zoomContainer" class="zoom-container">
          <img id="mainImage" class="main-img" src="<%= (product && product.images && product.images.length) ? product.images[0] : '/images/fallback.jpg' %>" 
               alt="<%= product && product.name ? (typeof product.name === 'string' ? product.name.replace(/</g, '&lt;').replace(/>/g, '&gt;') : 'Product') : 'Product Image' %>" 
               onerror="handleImageError(this, 'mainImage')" />
        </div>
        <div class="d-flex thumbs">
          <% (product && product.images || []).forEach((img, idx) => { %>
            <img src="<%= img %>" alt="Thumbnail" class="thumb-img-<%= idx %>" onerror="handleImageError(this, 'thumb-<%= idx %>')" onclick="setMainImage(this.src)" />
          <% }) %>
        </div>
      </div>

      <!-- Product Info -->
      <div class="col-lg-6">
        <h2 class="fw-bold"><%= product && product.name ? (typeof product.name === 'string' ? product.name.replace(/</g, '&lt;').replace(/>/g, '&gt;') : 'Product') : 'Product' %></h2>
        <p class="text-secondary"><%= product && product.companyDetails ? (typeof product.companyDetails === 'string' ? product.companyDetails.replace(/</g, '&lt;').replace(/>/g, '&gt;') : '') : '' %> | Series: <%= product && product.series ? (typeof product.series === 'string' ? product.series.replace(/</g, '&lt;').replace(/>/g, '&gt;') : '') : '' %></p>

        <div class="d-flex align-items-baseline gap-3 mb-3">
          <h4 class="mb-0"><small class="text-muted"><del>‚Çπ<%= product && product.originalPrice || '' %></del></small></h4>
          <h3 class="fw-bold mb-0" id="currentPrice">‚Çπ</h3>
          <span class="badge bg-success" id="stockBadge"></span>
        </div>

        <p><%= product && product.description ? (typeof product.description === 'string' ? product.description.replace(/</g, '&lt;').replace(/>/g, '&gt;') : '') : '' %></p>

        <div class="d-flex gap-3 mb-4">
          <button id="addToCartBtn" class="btn-dark-custom"
            data-product-name="<%= product && product.name ? (typeof product.name === 'string' ? product.name.replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\"/g, '&quot;') : '') : '' %>"
            data-product-id="<%= product && product._id || '' %>"
            data-variant-id="">
            Add to Cart
          </button>
          <button id="wishlistBtn" class="btn-light-custom"
            data-product-name="<%= product && product.name ? (typeof product.name === 'string' ? product.name.replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\"/g, '&quot;') : '') : '' %>"
            data-product-id="<%= product && product._id || '' %>"
            data-variant-id="">
            ‚ù§ Wishlist
          </button>
        </div>

        <!-- Variants -->
        <h5 class="fw-bold mb-3">Available Variants</h5>
        <div id="variantsWrap">
          <% if (product && product.combProduct && product.combProduct.length) { %>
            <% (product.combProduct || []).forEach((variant, idx) => { %>
              <div class="variant-card" data-variant-index="<%= idx %>">
                <p class="fw-semibold mb-1"><%= variant && variant.processor ? (typeof variant.processor === 'string' ? variant.processor.replace(/</g, '&lt;').replace(/>/g, '&gt;') : '') : '' %></p>
                <small>
                  RAM: <%= variant && variant.ram ? (typeof variant.ram === 'string' ? variant.ram.replace(/</g, '&lt;').replace(/>/g, '&gt;') : '') : '' %> | 
                  Storage: <%= variant && variant.storage ? (typeof variant.storage === 'string' ? variant.storage.replace(/</g, '&lt;').replace(/>/g, '&gt;') : '') : '' %> | 
                  GPU: <%= variant && variant.graphics ? (typeof variant.graphics === 'string' ? variant.graphics.replace(/</g, '&lt;').replace(/>/g, '&gt;') : '') : '' %>
                </small>
                <div class="d-flex justify-content-between align-items-center mt-2">
                  <span class="fw-bold">‚Çπ<%= variant && variant.price || '' %></span>
                  <span class="badge bg-secondary"><%= variant && (variant.stock ?? 0) %> in stock</span>
                </div>
              </div>
            <% }) %>
          <% } else { %>
            <p>No variants available for this product.</p>
          <% } %>
        </div>
      </div>
    </div>

    <!-- Specifications -->
    <div class="tab-pane fade show active mt-4" id="specs">
      <div class="section-title">Specifications</div>
      <div class="table-responsive">
        <table class="table table-striped table-hover align-middle shadow-sm rounded">
          <tbody id="specTableBody">
            <tr><th scope="row" class="w-25">Processor</th><td id="tdProcessor">‚Äî</td></tr>
            <tr><th scope="row">RAM</th><td id="tdRam">‚Äî</td></tr>
            <tr><th scope="row">Storage</th><td id="tdStorage">‚Äî</td></tr>
            <tr><th scope="row">Graphics</th><td id="tdGraphics">‚Äî</td></tr>
            <tr><th scope="row">Display</th><td id="tdDisplay">‚Äî</td></tr>
            <tr><th scope="row">Color</th><td id="tdColor">‚Äî</td></tr>
            <tr><th scope="row">Operating System</th><td><%= product && product.OS ? (typeof product.OS === 'string' ? product.OS.replace(/</g, '&lt;').replace(/>/g, '&gt;') : '') : '' %></td></tr>
            <tr><th scope="row">Dimension</th><td><%= product && product.dimension ? (typeof product.dimension === 'string' ? product.dimension.replace(/</g, '&lt;').replace(/>/g, '&gt;') : '') : '' %></td></tr>
            <tr><th scope="row">Series</th><td><%= product && product.series ? (typeof product.series === 'string' ? product.series.replace(/</g, '&lt;').replace(/>/g, '&gt;') : '') : '' %></td></tr>
            <tr><th scope="row">Included Items</th><td><%= product && product.packageItems ? (typeof product.packageItems === 'string' ? product.packageItems.replace(/</g, '&lt;').replace(/>/g, '&gt;') : '') : '' %></td></tr>
            <tr><th scope="row">Created At</th><td><%= product && product.createdAt ? new Date(product.createdAt).toDateString() : '' %></td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="mt-5">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <div class="section-title">Related Products</div>
        <a href="/search" class="btn-dark-custom btn-sm">View All Products</a>
      </div>
      <div class="scroll-container">
        <% (relatedProducts || []).forEach((p, idx) => { %>
          <div class="slide-card">
            <a href="/all-product/product-details/<%= p._id || '' %>" class="text-decoration-none">
              <img class="related-img-<%= idx %>" src="<%= (p.images && p.images[0]) || '/images/fallback.jpg' %>" 
                   alt="<%= (p.name && typeof p.name === 'string') ? p.name.replace(/</g, '&lt;').replace(/>/g, '&gt;') : 'Product' %>" 
                   onerror="handleImageError(this, 'related-<%= idx %>')" />
              <p class="fw-semibold"><%= (p.name && typeof p.name === 'string') ? p.name.replace(/</g, '&lt;').replace(/>/g, '&gt;') : '' %></p>
              <span class="fw-bold">‚Çπ<%= p.originalPrice || '' %></span>
            </a>
          </div>
        <% }) %>
      </div>
    </div>

    <!-- Flash Sale Section -->
    <div class="mt-5">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <div class="section-title">Flash Sales</div>
        <a href="/search" class="btn-dark-custom btn-sm">View All Products</a>
      </div>
      <div class="scroll-container">
        <% (products || []).forEach((p, idx) => { %>
          <div class="slide-card">
            <a href="/all-product/product-details/<%= p._id || '' %>" class="text-decoration-none">
              <img class="flash-img-<%= idx %>" src="<%= (p.images && p.images[0]) || '/images/fallback.jpg' %>" 
                   alt="<%= (p.name && typeof p.name === 'string') ? p.name.replace(/</g, '&lt;').replace(/>/g, '&gt;') : 'Product' %>" 
                   onerror="handleImageError(this, 'flash-<%= idx %>')" />
              <p class="fw-semibold"><%= (p.name && typeof p.name === 'string') ? p.name.replace(/</g, '&lt;').replace(/>/g, '&gt;') : '' %></p>
              <span class="fw-bold">‚Çπ<%= p.originalPrice || '' %></span>
            </a>
          </div>
        <% }) %>
      </div>
    </div>

    <!-- Reviews Section -->
    <div class="mt-5">
      <div class="section-title">Customer Reviews</div>
      <div class="mb-4">
        <% 
        const dummyReviews = [
          { name: "Alice", rating: 5, comment: "Amazing product! Highly recommend. The build quality is excellent and the performance is top notch. I have been using it for a few weeks and I am extremely satisfied with the purchase." },
          { name: "Bob", rating: 4, comment: "Good quality but delivery took time. Overall the experience is positive, but the delay was frustrating." },
          { name: "Charlie", rating: 5, comment: "Exceeded my expectations! The display is stunning and the battery lasts long. Perfect for gaming and work." }
        ]; 
        %>
        <% dummyReviews.forEach((r, idx) => { %>
          <div class="review-card p-3 mb-3 rounded shadow-sm" data-index="<%= idx %>">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <strong><%= r.name %></strong>
              <span><% for(let i=0; i<r.rating; i++){ %>‚≠ê<% } %></span>
            </div>
            <p class="review-text mb-1"><%= r.comment.split(' ').slice(0,10).join(' ') %>...</p>
            <a href="javascript:void(0)" class="read-more">Read more</a>
          </div>
        <% }) %>
      </div>
    </div>
  </div>

  <%- include('partials/footer') %>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <script>
    // ---------- Fixed Complete Debug Setup (No Prototype Overrides) ----------
    console.groupCollapsed('Product Details ‚Äî FIXED DEBUG LOG');
    console.time('page-total-load');
    console.timeStamp('Debug: Script start');

    // Global error and rejection handlers (enhanced with object stringification)
    window.addEventListener('error', e => {
      const errObj = {
        message: e.message || 'Unknown error',
        filename: e.filename,
        lineno: e.lineno,
        colno: e.colno,
        error: e.error ? (e.error.stack || e.error.toString()) : 'No error object',
        timestamp: new Date().toISOString()
      };
      console.error('üö® Uncaught Error:', errObj);
    });
    window.addEventListener('unhandledrejection', e => {
      console.error('üö® Unhandled Promise Rejection:', {
        reason: e.reason ? (e.reason.stack || e.reason.toString()) : 'Unknown reason',
        timestamp: new Date().toISOString()
      });
    });

    // Performance marks
    if (performance) {
      performance.mark('debug-script-init');
    }

    // Safe fetch interceptor
    const originalFetch = window.fetch;
    window.fetch = function(...args) {
      console.time(`fetch-${args[0]?.url || 'unknown'}`);
      console.debug('üîÑ Fetch started:', { url: args[0], method: args[1]?.method || 'GET', timestamp: new Date().toISOString() });
      return originalFetch.apply(this, args).then(response => {
        console.timeEnd(`fetch-${args[0]?.url || 'unknown'}`);
        console.debug('‚úÖ Fetch completed:', { url: args[0], status: response.status, timestamp: new Date().toISOString() });
        return response;
      }).catch(err => {
        console.timeEnd(`fetch-${args[0]?.url || 'unknown'}`);
        console.error('‚ùå Fetch failed:', { url: args[0], error: err.toString(), timestamp: new Date().toISOString() });
        throw err;
      });
    };

    // Manual image monitoring function (safe, per-image)
    let imageLoadCount = 0;
    let imageErrorCount = 0;
    function handleImageLoad(img, id) {
      imageLoadCount++;
      console.debug('‚úÖ Image loaded:', { id, src: img.src, naturalWidth: img.naturalWidth, naturalHeight: img.naturalHeight, timestamp: new Date().toISOString() });
    }
    function handleImageError(img, id) {
      imageErrorCount++;
      console.error('‚ùå Image load error:', { id, src: img.src, timestamp: new Date().toISOString() });
      if (img.src !== '/images/fallback.jpg') {
        img.src = '/images/fallback.jpg';
        console.debug('üîÑ Fallback applied:', { id, timestamp: new Date().toISOString() });
      }
    }
    function attachImageListeners(imgSelector, idPrefix) {
      const imgs = document.querySelectorAll(imgSelector);
      imgs.forEach((img, idx) => {
        img.addEventListener('load', () => handleImageLoad(img, `${idPrefix}-${idx}`), { once: true });
        img.addEventListener('error', () => handleImageError(img, `${idPrefix}-${idx}`), { once: true });
      });
      console.debug('üîç Attached listeners to images:', { selector: imgSelector, count: imgs.length, timestamp: new Date().toISOString() });
    }

    // DOM mutation observer (throttled: only large changes)
    let mutationCount = 0;
    const observer = new MutationObserver((mutations) => {
      const totalAdded = mutations.reduce((sum, m) => sum + (m.addedNodes ? m.addedNodes.length : 0), 0);
      if (totalAdded > 5) {  // Threshold to avoid spam
        mutationCount++;
        console.warn('üîÑ Large DOM Mutation Detected (potential loop?: count=' + mutationCount + ')', {
          totalAdded,
          timestamp: new Date().toISOString()
        });
      }
    });
    observer.observe(document.body, { childList: true, subtree: true });

    // Resource timing
    if (performance.getEntriesByType) {
      setTimeout(() => {
        const resources = performance.getEntriesByType('resource');
        console.table(resources.slice(-10).map(r => ({  // Last 10 only
          name: r.name,
          initiatorType: r.initiatorType,
          duration: r.duration.toFixed(2) + 'ms',
          startTime: r.startTime.toFixed(2) + 'ms'
        })));
        console.debug('üìä Resource summary:', { total: resources.length, slowest: Math.max(...resources.map(r => r.duration)).toFixed(2) + 'ms' });
      }, 2000);
    }

    // Memory monitoring
    if (performance.memory) {
      setInterval(() => {
        const mem = performance.memory;
        console.debug('üíæ Memory Usage:', {
          used: (mem.usedJSHeapSize / 1024 / 1024).toFixed(2) + 'MB',
          total: (mem.totalJSHeapSize / 1024 / 1024).toFixed(2) + 'MB',
          limit: (mem.jsHeapSizeLimit / 1024 / 1024).toFixed(2) + 'MB',
          timestamp: new Date().toISOString()
        });
      }, 5000);
    }

    // Embed data
    try {
      window.PRODUCT = <%- JSON.stringify(product || {}) %>;
      window.DUMMY_REVIEWS = <%- JSON.stringify(dummyReviews || []) %>;
      console.debug('üì¶ Embedded data:', { 
        productKeys: Object.keys(PRODUCT).length, 
        reviewsLen: DUMMY_REVIEWS.length,
        timestamp: new Date().toISOString()
      });
    } catch (err) {
      console.error('‚ùå Embed failed:', err.toString());
      window.PRODUCT = {}; window.DUMMY_REVIEWS = [];
    }

    // DOM elements
    const elements = {
      variantsWrap: document.getElementById('variantsWrap'),
      priceEl: document.getElementById('currentPrice'),
      stockBadgeEl: document.getElementById('stockBadge'),
      tdProcessor: document.getElementById('tdProcessor'),
      tdRam: document.getElementById('tdRam'),
      tdStorage: document.getElementById('tdStorage'),
      tdGraphics: document.getElementById('tdGraphics'),
      tdDisplay: document.getElementById('tdDisplay'),
      tdColor: document.getElementById('tdColor'),
      addToCartBtn: document.getElementById('addToCartBtn'),
      wishlistBtn: document.getElementById('wishlistBtn'),
      zoomContainer: document.getElementById('zoomContainer'),
      mainImage: document.getElementById('mainImage')
    };
    console.debug('üîç DOM Elements:', Object.fromEntries(Object.entries(elements).map(([k,v]) => [k, !!v])), { timestamp: new Date().toISOString() });

    // Utilities
    function debounce(func, wait) {
      let timeout;
      return function (...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), wait);
      };
    }

    // Preload with logging
    function preloadBackground(src, callback) {
      console.time(`preload-${src.split('/').pop()}`);
      console.debug('‚è≥ Preloading:', src);
      const img = new Image();
      img.onload = () => {
        console.timeEnd(`preload-${src.split('/').pop()}`);
        if (elements.zoomContainer) {
          elements.zoomContainer.style.backgroundImage = `url('${src}')`;
          elements.zoomContainer.classList.remove('loading');
          console.debug('‚úÖ Background set');
        }
        callback?.();
      };
      img.onerror = () => {
        console.timeEnd(`preload-${src.split('/').pop()}`);
        console.error('‚ùå Preload error:', src);
        if (elements.zoomContainer) {
          elements.zoomContainer.style.backgroundImage = `url('/images/fallback.jpg')`;
          elements.zoomContainer.classList.remove('loading');
        }
        callback?.();
      };
      img.src = src;
    }

    function setMainImage(src) {
      console.time('setMainImage');
      console.debug('üñºÔ∏è setMainImage:', src);
      try {
        if (!src) {
          elements.mainImage.src = '/images/fallback.jpg';
          if (elements.zoomContainer) {
            elements.zoomContainer.classList.add('loading');
            preloadBackground('/images/fallback.jpg');
          }
          return;
        }
        elements.mainImage.src = src;
        if (elements.zoomContainer) {
          elements.zoomContainer.classList.add('loading');
          preloadBackground(src);
        }
      } catch (err) {
        console.error('‚ùå setMainImage error:', err);
      } finally {
        console.timeEnd('setMainImage');
      }
    }

    function selectVariant(index) {
      console.time('selectVariant');
      console.debug('‚öôÔ∏è selectVariant:', index);
      try {
        const variants = window.PRODUCT?.combProduct || [];
        if (!variants.length) return console.warn('‚ö†Ô∏è No variants');
        const i = Math.max(0, Math.min(index, variants.length - 1));
        const v = variants[i];
        // UI/Specs updates (as before, but with elements check)
        if (elements.variantsWrap) {
          [...elements.variantsWrap.querySelectorAll('.variant-card')].forEach(c => c.classList.remove('active'));
          const activeCard = elements.variantsWrap.querySelector(`[data-variant-index="${i}"]`);
          if (activeCard) activeCard.classList.add('active');
        }
        if (elements.priceEl) elements.priceEl.textContent = '‚Çπ' + (v.price ?? '');
        if (elements.stockBadgeEl) elements.stockBadgeEl.textContent = (v.stock ?? 0) + ' in stock';
        [elements.tdProcessor, elements.tdRam, elements.tdStorage, elements.tdGraphics, elements.tdDisplay, elements.tdColor]
          ?.forEach((el, j) => { if (el) el.textContent = [v.processor, v.ram, v.storage, v.graphics, v.display, v.color][j] ?? '‚Äî'; });
        if (elements.addToCartBtn) elements.addToCartBtn.setAttribute('data-variant-id', v._id || '');
        if (elements.wishlistBtn) elements.wishlistBtn.setAttribute('data-variant-id', v._id || '');
        console.debug('‚úÖ Variant:', i);
      } catch (err) {
        console.error('‚ùå selectVariant error:', err);
      } finally {
        console.timeEnd('selectVariant');
      }
    }

    function bindVariantClicks() {
      if (!elements.variantsWrap) return console.warn('‚ö†Ô∏è No variantsWrap');
      let clicks = 0;
      elements.variantsWrap.addEventListener('click', e => {
        clicks++;
        const card = e.target.closest('.variant-card');
        if (card) selectVariant(Number(card.dataset.variantIndex));
        console.debug('üñ±Ô∏è Variant click:', clicks);
      });
    }

    // Mousemove (debounced)
    let moveCount = 0;
    if (elements.zoomContainer) {
      elements.zoomContainer.addEventListener('mousemove', debounce(e => {
        moveCount++;
        const rect = elements.zoomContainer.getBoundingClientRect();
        const x = ((e.clientX - rect.left) / rect.width) * 100;
        const y = ((e.clientY - rect.top) / rect.height) * 100;
        elements.zoomContainer.style.backgroundPosition = `${x}% ${y}%`;
        console.debug('üñ±Ô∏è Mousemove:', moveCount);  // Throttle logs if needed
      }, 100));
    }

    // Main image listener (manual)
    if (elements.mainImage) {
      elements.mainImage.addEventListener('load', () => {
        console.debug('üñºÔ∏è Main loaded');
        if (elements.zoomContainer) elements.zoomContainer.classList.remove('loading');
        setMainImage(elements.mainImage.src);
      }, { once: true });
      elements.mainImage.addEventListener('error', () => handleImageError(elements.mainImage, 'mainImage'), { once: true });
    }

    // DOMContentLoaded (wrapped)
    document.addEventListener('DOMContentLoaded', () => {
      console.time('DOMContentLoaded');
      try {
        console.assert(!!elements.zoomContainer, 'zoomContainer missing');
        attachImageListeners('#mainImage', 'main');  // Specific
        attachImageListeners('.thumbs img', 'thumb');
        attachImageListeners('.related-img', 'related');
        attachImageListeners('.flash-img', 'flash');
        if (window.PRODUCT.images?.length) setMainImage(window.PRODUCT.images[0]);
        if (window.PRODUCT.combProduct?.length) selectVariant(0);
        bindVariantClicks();
        console.debug('‚úÖ Init complete');
      } catch (err) {
        console.error('‚ùå Init error:', err);
      }
      console.timeEnd('DOMContentLoaded');
    });

    // Add to Cart functionality with timeout + enhanced logging
    if (elements.addToCartBtn) {
      let cartClickCount = 0;
      elements.addToCartBtn.addEventListener('click', async () => {
        cartClickCount++;
        console.time('addToCart-full');
        console.debug('üõí AddToCart clicked:', { count: cartClickCount, timestamp: new Date().toISOString() });
        const productId = elements.addToCartBtn.getAttribute('data-product-id');
        const variantId = elements.addToCartBtn.getAttribute('data-variant-id');
        const productName = elements.addToCartBtn.getAttribute('data-product-name');

        if (!variantId) {
          console.warn('‚ö†Ô∏è No variantId for addToCart', { timestamp: new Date().toISOString() });
          Swal.fire({ title: 'Select a Variant', text: 'Please select a variant before adding to cart.', icon: 'warning', confirmButtonText: 'OK' });
          return;
        }

        const controller = new AbortController();
        const timeoutId = setTimeout(() => { 
          controller.abort(); 
          console.warn('‚è∞ addToCart fetch aborted due to 5s timeout', { timestamp: new Date().toISOString() }); 
        }, 5000);

        try {
          console.time('fetch-addToCart');
          const res = await fetch('/cart/add', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ productId, variantId, productName }),
            signal: controller.signal
          });
          clearTimeout(timeoutId);
          console.timeEnd('fetch-addToCart');

          if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
          const data = await res.json();
          console.debug('üõí addToCart response:', data);

          if (data.loginRequired) {
            console.warn('üîê Login required for addToCart', { timestamp: new Date().toISOString() });
            Swal.fire({ icon: 'warning', title: 'Login Required', text: data.message || 'Please login to continue.', showCancelButton: true, confirmButtonText: 'Login', cancelButtonText: 'Cancel' }).then(r => { if (r.isConfirmed) window.location.href = '/login'; });
            return;
          }

          if (data.success) {
            console.debug('‚úÖ addToCart success', { timestamp: new Date().toISOString() });
            Swal.fire({ icon: 'success', title: 'Added to Cart!', text: 'Your product has been added.', showCancelButton: true, confirmButtonText: 'Go to Cart üõí', cancelButtonText: 'Continue Shopping', timer: 3000, timerProgressBar: true }).then(result => { if (result.isConfirmed) window.location.href = '/cart'; });
          } else {
            console.warn('‚ö†Ô∏è addToCart failed:', data.message);
            let errorTitle = 'Error';
            let errorText = data.message || 'Failed to update the cart.';
            if (data.message === 'Variant not found') { errorTitle = 'Variant Unavailable'; errorText = 'The selected variant is not available.'; }
            else if (data.message === 'Cannot add more, stock limit reached') { errorTitle = 'Stock Limit Reached'; errorText = 'You cannot add more of this item due to stock limitations.'; }
            else if (data.message === 'Product is out of stock') { errorTitle = 'Out of Stock'; errorText = 'This product is currently out of stock.'; }

            Swal.fire({ title: errorTitle, text: errorText, icon: data.message === 'Variant not found' ? 'error' : 'warning', confirmButtonText: 'OK' });
          }
        } catch (err) {
          clearTimeout(timeoutId);
          console.error('‚ùå Fetch error (addToCart):', err);
          Swal.fire({ icon: "warning", title: "Oops...", text: "Login to continue..!", confirmButtonText: 'OK' });
        }
        console.timeEnd('addToCart-full');
      });
    } else {
      console.warn('‚ö†Ô∏è addToCartBtn not found', { timestamp: new Date().toISOString() });
    }

    // Wishlist functionality with enhanced logging
    if (elements.wishlistBtn) {
      let wishlistClickCount = 0;
      elements.wishlistBtn.addEventListener('click', async () => {
        wishlistClickCount++;
        console.time('wishlist-full');
        console.debug('‚ù§Ô∏è Wishlist clicked:', { count: wishlistClickCount, timestamp: new Date().toISOString() });
        const productId = elements.wishlistBtn.getAttribute('data-product-id');
        const variantId = elements.wishlistBtn.getAttribute('data-variant-id');
        const productName = elements.wishlistBtn.getAttribute('data-product-name');

        if (!variantId) {
          console.warn('‚ö†Ô∏è No variantId for wishlist', { timestamp: new Date().toISOString() });
          Swal.fire({ title: 'Select a Variant', text: 'Please select a variant before adding to wishlist.', icon: 'warning', confirmButtonText: 'OK' });
          return;
        }

        const controller = new AbortController();
        const timeoutId = setTimeout(() => { 
          controller.abort(); 
          console.warn('‚è∞ wishlist fetch aborted due to 5s timeout', { timestamp: new Date().toISOString() }); 
        }, 5000);

        try {
          console.time('fetch-wishlist');
          const res = await fetch('/wishlist', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ productId, variantId, productName }),
            signal: controller.signal
          });
          clearTimeout(timeoutId);
          console.timeEnd('fetch-wishlist');

          if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
          const data = await res.json();
          console.debug('‚ù§Ô∏è wishlist response:', data);

          if (data.loginRequired) {
            console.warn('üîê Login required for wishlist', { timestamp: new Date().toISOString() });
            Swal.fire({ icon: 'warning', title: 'Login Required', text: data.message || 'Please login to add to wishlist.', showCancelButton: true, confirmButtonText: 'Login', cancelButtonText: 'Cancel' }).then(r => { if (r.isConfirmed) window.location.href = '/login'; });
            return;
          }

          if (data.success) {
            Swal.fire({ icon: 'success', title: 'Added to Wishlist!', text: 'Your product has been added to your wishlist.', showCancelButton: true, confirmButtonText: 'Go to Wishlist', cancelButtonText: 'Continue Shopping', timer: 3000, timerProgressBar: true }).then(result => { if (result.isConfirmed) window.location.href = '/viewWishList'; });
          } else {
            console.warn('‚ö†Ô∏è wishlist failed:', data.message);
            let errorTitle = 'Error';
            let errorText = data.message || 'Failed to add to wishlist.';
            if (data.message === 'Variant not found') { errorTitle = 'Variant Unavailable'; errorText = 'The selected variant is not available.'; }
            else if (data.message === 'Product already in wishlist') { errorTitle = 'Already in Wishlist'; errorText = 'This product is already in your wishlist.'; }

            Swal.fire({ title: errorTitle, text: errorText, icon: data.message === 'Variant not found' ? 'error' : 'warning', confirmButtonText: 'OK' });
          }
        } catch (err) {
          clearTimeout(timeoutId);
          console.error('‚ùå Fetch error (wishlist):', err);
          Swal.fire({ icon: "warning", title: "Oops...", text: "Login to continue..!", confirmButtonText: 'OK' });
        }
      });
    } else {
      console.warn('‚ö†Ô∏è wishlistBtn not found', { timestamp: new Date().toISOString() });
    }

    // Reviews toggle with logging
    try {
      const reviewCards = document.querySelectorAll('.review-card');
      console.debug('üìù Reviews init:', { cardCount: reviewCards.length, timestamp: new Date().toISOString() });
      if (window.DUMMY_REVIEWS && window.DUMMY_REVIEWS.length) {
        reviewCards.forEach(card => {
          const readMore = card.querySelector('.read-more');
          const reviewText = card.querySelector('.review-text');
          const idx = parseInt(card.dataset.index);

          if (readMore && reviewText && window.DUMMY_REVIEWS[idx]) {
            const fullText = window.DUMMY_REVIEWS[idx].comment;
            const shortText = fullText.split(' ').slice(0, 10).join(' ') + '...';

            readMore.addEventListener('click', () => {
              const expanded = card.classList.toggle('expanded');
              if (expanded) { 
                reviewText.textContent = fullText; 
                readMore.textContent = 'Show less'; 
              } else { 
                reviewText.textContent = shortText; 
                readMore.textContent = 'Read more'; 
              }
            });
          }
        });
      }
    } catch (err) {
      console.error('‚ùå Reviews init error:', err);
    }

 

    // Bootstrap debug end
  </script>
</body>
</html>