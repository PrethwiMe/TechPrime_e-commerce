<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Meta -->
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>My Orders â€¢ Account</title>

    <!-- Bootstrap + Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />

    <style>
      :root {
        --brand: #0ea5e9;
        --bg: #0b1220;
        --surface: #111827;
        --border: #1f2937;
        --text: #e5e7eb;
        --muted: #9ca3af;
        --success: #22c55e;
        --warning: #f59e0b;
        --danger: #ef4444;
      }
      html, body { background-color: var(--bg); color: var(--text); }
      a, a:hover, a:focus { color: var(--brand); }

      .content-wrapper { margin-left: 260px; padding: 1.5rem; }
      @media (max-width: 768px) { .content-wrapper { margin-left: 0; padding: 1rem; } }

      .page-header { border-bottom: 1px solid var(--border); margin-bottom: 1rem; padding-bottom: 0.75rem; }
      .card-dark { background-color: var(--surface); border: 1px solid var(--border); color: var(--text); }
      .table-darkish { --bs-table-bg: transparent; --bs-table-striped-bg: rgba(255,255,255,0.03); --bs-table-striped-color: var(--text); --bs-table-hover-bg: rgba(255,255,255,0.05); --bs-table-hover-color: var(--text); color: var(--text); border-color: var(--border); }
      .badge-status { font-weight: 600; letter-spacing: .02em; }
      .badge-status.shipped { background-color: rgba(14,165,233,0.15); color: #7dd3fc; border: 1px solid rgba(125,211,252,0.3); }
      .badge-status.delivered { background-color: rgba(34,197,94,0.15); color: #86efac; border: 1px solid rgba(134,239,172,0.3); }
      .badge-status.processing { background-color: rgba(245,158,11,0.15); color: #facc15; border: 1px solid rgba(250,204,21,0.3); }
      .badge-status.cancelled { background-color: rgba(239,68,68,0.15); color: #fca5a5; border: 1px solid rgba(252,165,165,0.3); }

      .btn-brand { background-color: var(--brand); border-color: var(--brand); color: #07131c; }
      .btn-brand:hover { filter: brightness(1.05); color: #07131c; }
      .text-muted-2 { color: var(--muted) !important; }
      .order-item-thumb { width: 64px; height: 64px; border-radius: .5rem; background-color: #0f172a; object-fit: cover; border: 1px solid var(--border); }
      .divider { height: 1px; background-color: var(--border); width: 100%; }
      .filter-chip { border: 1px solid var(--border); background: transparent; color: var(--text); }
      .filter-chip.active { background: rgba(14,165,233,0.12); border-color: rgba(14,165,233,0.35); color: #7dd3fc; }
      .order-actions .btn { --bs-btn-padding-y: .35rem; --bs-btn-padding-x: .6rem; --bs-btn-font-size: .875rem; }
    </style>
  </head>

  <body>
    <!-- Header partial -->
    <%- include('partials/header') %>
    <!-- Account Sidebar partial -->
    <%- include('partials/accountSidebar') %>

    <main class="content-wrapper">
      <header class="page-header d-flex flex-wrap align-items-center justify-content-between gap-3">
        <div>
          <h1 class="h3 mb-1">My Orders</h1>
          <p class="mb-0 text-muted-2">Track, manage, and view your laptop orders</p>
        </div>
        <div class="d-flex align-items-center gap-2">
          <button class="btn filter-chip active" data-filter="all"><i class="bi bi-card-list me-1"></i> All</button>
          <button class="btn filter-chip" data-filter="processing"><i class="bi bi-hourglass-split me-1"></i> Processing</button>
          <button class="btn filter-chip" data-filter="shipped"><i class="bi bi-truck me-1"></i> Shipped</button>
          <button class="btn filter-chip" data-filter="delivered"><i class="bi bi-check2-circle me-1"></i> Delivered</button>
          <button class="btn filter-chip" data-filter="cancelled"><i class="bi bi-x-circle me-1"></i> Cancelled</button>
        </div>
      </header>

      <!-- Orders List -->
      <section id="ordersList" class="vstack gap-3">
        <% orders.forEach(order => { %>
          <article class="card card-dark order-card" data-status="<%= order.status.toLowerCase() %>">
            <div class="card-body">
              <div class="d-flex flex-wrap align-items-center justify-content-between gap-2">
                <div class="d-flex flex-wrap align-items-center gap-3">
                  <span class="badge badge-status <%= order.status.toLowerCase() %> text-uppercase">
                    <i class="bi me-1
                      <%= order.status === 'processing' ? 'bi-hourglass-split' :
                          order.status === 'shipped' ? 'bi-truck' :
                          order.status === 'delivered' ? 'bi-check2-circle' : 'bi-x-circle' %>"></i>
                    <%= order.status %>
                  </span>
                  <span class="text-muted-2">Order ID</span>
                  <strong><%= order.orderId %></strong>
                  <span class="vr mx-2" style="background-color: var(--border);"></span>
                  <span class="text-muted-2"><i class="bi bi-calendar-date me-1"></i> <%= new Date(order.createdAt).toLocaleDateString() %></span>
                </div>

                <div class="order-actions d-flex align-items-center gap-2">
                  <button class="btn btn-outline-light border-secondary" data-order="<%= order.orderId %>"><i class="bi bi-eye me-1"></i> View</button>
                  <% if (['shipped','processing'].includes(order.status.toLowerCase())) { %>
                    <button class="btn btn-outline-light border-secondary" data-track="<%= order.orderId %>"><i class="bi bi-geo-alt me-1"></i> Track</button>
                  <% } %>
                  <% if (order.status.toLowerCase() === 'delivered') { %>
                    <button class="btn btn-outline-light border-secondary" data-invoice="<%= order.orderId %>"><i class="bi bi-receipt me-1"></i> Invoice</button>
                  <% } %>
                  <% if (order.status.toLowerCase() === 'processing') { %>
                    <button class="btn btn-outline-danger border-danger-subtle" data-cancel="<%= order.orderId %>"><i class="bi bi-x-circle me-1"></i> Cancel</button>
                  <% } %>
                  <!-- New button to view full address -->
                  <button class="btn btn-outline-info border-info-subtle" data-address="<%= JSON.stringify(order.selectedAddress) %>">
                    <i class="bi bi-geo-alt me-1"></i> View Address
                  </button>
                </div>
              </div>

              <div class="my-3 divider"></div>

              <!-- Items -->
              <div class="table-responsive">
                <table class="table table-darkish align-middle mb-3">
                  <thead>
                    <tr>
                      <th scope="col">Item</th>
                      <th scope="col" class="text-center">Qty</th>
                      <th scope="col" class="text-end">Price</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% order.items.forEach(item => { %>
                      <tr>
                        <td>
                          <div class="d-flex align-items-center gap-3">
                            <img class="order-item-thumb" src="<%= item.product.images[0] %>" alt="Item image" />
                            <div>
                              <div class="fw-semibold"><%= item.product.name %></div>
                              <small class="text-muted-2">Category: Laptops & Accessories</small>
                            </div>
                          </div>
                        </td>
                        <td class="text-center"><%= item.quantity %></td>
                        <td class="text-end"><%= parseFloat(item.price).toFixed(2) %>/-</td>
                      </tr>
                    <% }) %>
                  </tbody>
                </table>
              </div>

              <div class="row g-3">
                <div class="col-12 col-md-6">
                  <div class="p-3 rounded-3" style="background: rgba(255,255,255,0.02); border: 1px dashed var(--border);">
                    <div class="text-muted-2 mb-1">Ship to</div>
                    <div class="fw-semibold"><i class="bi bi-geo-alt me-2"></i>
                      <%= order.selectedAddress.line1 %>, <%= order.selectedAddress.city %>, <%= order.selectedAddress.state %>, <%= order.selectedAddress.pincode %>
                    </div>
                  </div>
                </div>
                <div class="col-12 col-md-6">
                  <div class="p-3 rounded-3 d-flex align-items-center justify-content-between" style="background: rgba(255,255,255,0.02); border: 1px dashed var(--border);">
                    <div>
                      <div class="text-muted-2 mb-1">Order total</div>
                      <div class="fs-5 fw-bold"><%= parseFloat(order.total).toFixed(2) %>/-</div>
                    </div>
                    <button class="btn btn-brand"><i class="bi bi-box-arrow-in-down me-1"></i> Download Summary</button>
                  </div>
                </div>
              </div>
            </div>
          </article>
        <% }) %>
      </section>

      <!-- Pagination (dummy) -->
      <nav aria-label="Orders pagination" class="mt-4">
        <ul class="pagination pagination-sm mb-0">
          <li class="page-item disabled"><span class="page-link bg-transparent border-secondary text-muted-2">Previous</span></li>
          <li class="page-item active"><span class="page-link bg-transparent border-secondary" style="background: rgba(14,165,233,0.12); color:#7dd3fc; border-color: rgba(14,165,233,0.35);">1</span></li>
          <li class="page-item"><a class="page-link bg-transparent border-secondary text-light" href="#">2</a></li>
          <li class="page-item"><a class="page-link bg-transparent border-secondary text-light" href="#">3</a></li>
          <li class="page-item"><a class="page-link bg-transparent border-secondary text-light" href="#">Next</a></li>
        </ul>
      </nav>
    </main>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      const list = document.getElementById('ordersList');
      const chips = document.querySelectorAll('.filter-chip');
      const searchInput = document.getElementById('searchOrders');

      function applyFilters() {
        const activeChip = document.querySelector('.filter-chip.active');
        const status = activeChip ? activeChip.dataset.filter : 'all';
        const q = (searchInput.value || '').toLowerCase();

        list.querySelectorAll('.order-card').forEach(card => {
          const cardStatus = card.getAttribute('data-status');
          const text = card.innerText.toLowerCase();
          const matchStatus = status === 'all' || cardStatus === status;
          const matchText = !q || text.includes(q);
          card.style.display = (matchStatus && matchText) ? '' : 'none';
        });
      }

      chips.forEach(chip => {
        chip.addEventListener('click', () => {
          chips.forEach(c => c.classList.remove('active'));
          chip.classList.add('active');
          applyFilters();
        });
      });

      searchInput.addEventListener('input', applyFilters);

      document.addEventListener('click', (e) => {
        const view = e.target.closest('[data-order]');
        const track = e.target.closest('[data-track]');
        const invoice = e.target.closest('[data-invoice]');
        const cancelBtn = e.target.closest('[data-cancel]');
        const addressBtn = e.target.closest('[data-address]');

        if (view) alert('Viewing details for ' + view.getAttribute('data-order') + ' (demo)');
        if (track) alert('Tracking ' + track.getAttribute('data-track') + ' (demo)');
        if (invoice) alert('Downloading invoice for ' + invoice.getAttribute('data-invoice') + ' (demo)');
        if (cancelBtn && confirm('Cancel order ' + cancelBtn.getAttribute('data-cancel') + '?')) {
          alert('Order ' + cancelBtn.getAttribute('data-cancel') + ' cancelled (demo)');
        }
        if (addressBtn) {
          const addr = JSON.parse(addressBtn.getAttribute('data-address'));
          alert(`Full Delivery Address:\n${addr.fullName}\n${addr.line1}\n${addr.city}, ${addr.state} - ${addr.pincode}\nPhone: ${addr.phone}`);
        }
      });
    </script>
  </body>
</html>
