<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Offers Management | Admin</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet" />
  <style>
    .offer-type-badge { padding: 0.5rem 1rem; border-radius: 30px; font-size: 0.9rem; }
    .table-danger { background-color: rgba(220, 53, 69, 0.15) !important; }
    .opacity-75 { opacity: 0.75; }
    .badge { font-size: 0.85rem; padding: 0.5em 0.9em; }
    .empty-state i { font-size: 4rem; color: #ddd; }
    @media (min-width: 993px) {
    .flex-grow-1 {
      margin-left: 260px !important;
    }
  }

  /* Push content below fixed topbar */
  body {
    padding-top: 65px !important;
  }
  </style>
</head>
<body class="bg-light">

<div class="d-flex">
  <!-- Sidebar -->
  <%- include('partials/sidebar') %>

  <!-- Main Content -->
  <div class="flex-grow-1">
    <!-- Topbar -->
    <%- include('partials/topBar') %>

    <div class="container-fluid p-4">

      <!-- Header -->
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold text-dark"><i class="bi bi-tag-fill"></i> Offers Management</h2>
        <button class="btn btn-primary shadow-sm" data-bs-toggle="modal" data-bs-target="#addOfferModal">
          <i class="bi bi-plus-circle"></i> Add New Offer
        </button>
      </div>

      <!-- Offers Table -->
      <div class="card shadow border-0">
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover table-bordered align-middle text-center mb-0">
              <thead class="table-dark">
                <tr>
                  <th>Status</th>
                  <th>Type</th>
                  <th>Applies To</th>
                  <th>Offer Value</th>
                  <th>Start Date</th>
                  <th>End Date</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody>
                <% 
                  const formatDate = (date) => {
                    if (!date) return '-';
                    const d = new Date(date);
                    const day = String(d.getDate()).padStart(2, '0');
                    const month = d.toLocaleString('en-US', { month: 'short' });
                    const year = d.getFullYear();
                    return `${day}-${month}-${year}`;
                  };

                  const isExpired = (endDate) => new Date(endDate) < new Date().setHours(0,0,0,0);
                  const isUpcoming = (startDate) => new Date(startDate) > new Date().setHours(0,0,0,0);
                %>

                <% if (!offer || offer.length === 0) { %>
                  <tr>
                    <td colspan="7" class="py-5">
                      <div class="text-center empty-state">
                        <i class="bi bi-inbox"></i>
                        <p class="text-muted mt-3 fs-5">No offers found. Create your first offer!</p>
                      </div>
                    </td>
                  </tr>
                <% } else { %>
                  <% offer.forEach(item => { %>
                    <% const expired = isExpired(item.endDate); %>
                    <% const upcoming = isUpcoming(item.startDate); %>
                    <tr class="<%= expired ? 'table-danger opacity-75' : '' %>">
                      <!-- Status -->
                      <td>
                        <% if (expired) { %>
                          <span class="badge bg-danger">EXPIRED</span>
                        <% } else if (upcoming) { %>
                          <span class="badge bg-warning text-dark">UPCOMING</span>
                        <% } else { %>
                          <span class="badge bg-success">ACTIVE</span>
                        <% } %>
                      </td>

                      <!-- Type -->
                      <td>
                        <span class="badge bg-primary offer-type-badge">
                          <%= item.appliesTo.charAt(0).toUpperCase() + item.appliesTo.slice(1) %>
                        </span>
                      </td>

                      <!-- Applies To -->
                      <td class="<%= expired ? 'text-decoration-line-through' : '' %>">
                        <% if (item.appliesTo === 'product') { 
                          const product = products.find(p => p._id.toString() === item.productId?.toString()); %>
                          <%= product ? product.name : 'Product Not Found' %>
                        <% } else { 
                          const category = categories.find(c => c._id.toString() === item.categoryId?.toString()); %>
                          <%= category ? category.name : 'Category Not Found' %>
                        <% } %>
                      </td>

                      <!-- Value -->
                      <td class="<%= expired ? 'text-decoration-line-through' : '' %> fw-bold">
                        ₹<%= item.offerValue %>
                      </td>

                      <!-- Dates -->
                      <td><%= formatDate(item.startDate) %></td>
                      <td class="<%= expired ? 'text-danger fw-bold' : '' %>">
                        <%= formatDate(item.endDate) %>
                      </td>

                      <!-- Action -->
                      <td>
                        <button 
                          class="btn btn-sm btn-outline-danger delete-btn border-0" 
                          data-id="<%= item._id %>"
                          title="Disable Offer">
                          <i class="bi bi-trash-fill"></i> Disable
                        </button>
                      </td>
                    </tr>
                  <% }) %>
                <% } %>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Pagination -->
      <nav class="mt-4">
        <ul class="pagination justify-content-center">
          <% if (page > 1) { %>
            <li class="page-item">
              <a class="page-link" href="/admin/offers/<%= page - 1 %>">Previous</a>
            </li>
          <% } else { %>
            <li class="page-item disabled"><a class="page-link">Previous</a></li>
          <% } %>

          <% for (let i = 1; i <= totalPages; i++) { %>
            <li class="page-item <%= i === page ? 'active' : '' %>">
              <a class="page-link" href="/admin/offers/<%= i %>"><%= i %></a>
            </li>
          <% } %>

          <% if (page < totalPages) { %>
            <li class="page-item">
              <a class="page-link" href="/admin/offers/<%= page + 1 %>">Next</a>
            </li>
          <% } else { %>
            <li class="page-item disabled"><a class="page-link">Next</a></li>
          <% } %>
        </ul>
      </nav>

    </div>
  </div>
</div>

<!-- Add Offer Modal -->
<div class="modal fade" id="addOfferModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <form id="addOfferForm" class="modal-content">
      <div class="modal-header bg-dark text-white">
        <h5 class="modal-title"><i class="bi bi-plus-circle"></i> Add New Offer</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body bg-light">
        <div class="mb-3">
          <label class="form-label fw-bold">Applies To</label>
          <select id="appliesTo" class="form-select" onchange="toggleTarget()">
            <option value="product">Product</option>
            <option value="category">Category</option>
          </select>

          <select id="productDropdownAdd" class="form-select mt-2">
            <option value="">-- Select Product --</option>
            <% products.forEach(p => { %>
              <option value="<%= p._id %>"><%= p.name %></option>
            <% }) %>
          </select>

          <select id="categoryDropdownAdd" class="form-select mt-2" style="display:none;">
            <option value="">-- Select Category --</option>
            <% categories.forEach(c => { %>
              <option value="<%= c._id %>"><%= c.name %></option>
            <% }) %>
          </select>
        </div>

        <div class="mb-3">
          <label class="form-label fw-bold">Offer Value (₹)</label>
          <input type="number" id="offerValueAdd" class="form-control" min="1"  />
        </div>

        <div class="mb-3">
          <label class="form-label fw-bold">Start Date</label>
          <input type="date" id="startDateAdd" class="form-control"  />
        </div>

        <div class="mb-3">
          <label class="form-label fw-bold">End Date</label>
          <input type="date" id="endDateAdd" class="form-control"  />
        </div>
      </div>
      <div class="modal-footer bg-light">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" class="btn btn-primary">Save Offer</button>
      </div>
    </form>
  </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
  // Toggle Product/Category Dropdown
  function toggleTarget() {
    const appliesTo = document.getElementById('appliesTo').value;
    document.getElementById('productDropdownAdd').style.display = appliesTo === 'product' ? 'block' : 'none';
    document.getElementById('categoryDropdownAdd').style.display = appliesTo === 'category' ? 'block' : 'none';
  }
  document.addEventListener('DOMContentLoaded', toggleTarget);

  // Add New Offer - Show Backend Message
  document.getElementById('addOfferForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const appliesTo = document.getElementById('appliesTo').value;
    const productId = document.getElementById('productDropdownAdd').value;
    const categoryId = document.getElementById('categoryDropdownAdd').value;
    const offerValue = document.getElementById('offerValueAdd').value;
    const startDate = document.getElementById('startDateAdd').value;
    const endDate = document.getElementById('endDateAdd').value;

    if (!offerValue || !startDate || !endDate) {
      return Swal.fire('Error', 'All fields are required', 'error');
    }
    if (appliesTo === 'product' && !productId) {
      return Swal.fire('Error', 'Please select a product', 'error');
    }
    if (appliesTo === 'category' && !categoryId) {
      return Swal.fire('Error', 'Please select a category', 'error');
    }
    if (new Date(startDate) >= new Date(endDate)) {
      return Swal.fire('Error', 'End date must be after start date', 'error');
    }

    const payload = { appliesTo, offerValue, startDate, endDate };
    if (appliesTo === 'product') payload.productId = productId;
    if (appliesTo === 'category') payload.categoryId = categoryId;

    try {
      const response = await axios.post('/admin/offers/add', payload);
      
      // Success - Show backend message
      Swal.fire({
        icon: 'success',
        title: 'Success!',
        text: response.data.message || 'Offer added successfully!',
      }).then(() => location.reload());

    } catch (err) {
      const errorMsg = err.response?.data?.message || 
                      err.response?.data?.errors || 
                      'Failed to add offer. Please try again.';

      Swal.fire({
        icon: 'error',
        title: 'Error',
        text: errorMsg
      });
    }
  });

  // Disable Offer - Show Backend Message
  document.querySelectorAll('.delete-btn').forEach(btn => {
    btn.addEventListener('click', async function () {
      const offerId = this.getAttribute('data-id');

      const result = await Swal.fire({
        title: 'Disable Offer?',
        text: "This offer will no longer be visible to customers.",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        confirmButtonText: 'Yes, Disable',
        cancelButtonText: 'Cancel'
      });

      if (result.isConfirmed) {
        try {
          const res = await axios.put(`/admin/offers/${offerId}`, { Active: false });
          
          Swal.fire({
            icon: 'success',
            title: 'Disabled!',
            text: res.data.message || 'Offer has been disabled successfully.'
          }).then(() => location.reload());

        } catch (err) {
          const errorMsg = err.response?.data?.message || 'Failed to disable offer';
          Swal.fire('Error', errorMsg, 'error');
        }
      }
    });
  });
</script>

</body>
</html>