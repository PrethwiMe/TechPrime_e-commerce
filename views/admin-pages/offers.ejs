<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Offers - TechPrime Admin</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <link rel="stylesheet" href="/stylesheets/sidebar.css">
  <style>
    :root {
      --dark-primary: #1a1a2e;
      --dark-secondary: #16213e;
      --dark-accent: #0f3460;
      --accent-blue: #2563eb;
      --accent-green: #10b981;
      --accent-red: #ef4444;
      --text-dark: #1f2937;
      --text-light: #6b7280;
      --border-color: #e5e7eb;
    }

    body {
      margin: 0;
      padding: 0;
      background: white;
    }

    .main-content {
      flex-grow: 1;
      min-height: 100vh;
      background: white;
    }

    .navbar {
      width: 100%;
      position: fixed;
      top: 0;
      z-index: 1000;
    }

    .content-wrapper {
      margin-top: 60px;
      padding: 2rem;
    }

    .page-header {
      background: linear-gradient(135deg, var(--dark-primary) 0%, var(--dark-secondary) 100%);
      padding: 2rem;
      border-radius: 1rem;
      margin-bottom: 2rem;
      box-shadow: 0 10px 30px rgba(26, 26, 46, 0.15);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .page-header h2 {
      color: white;
      font-size: 1.875rem;
      font-weight: 700;
      margin: 0;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .btn-add-offer {
      background: white;
      color: var(--dark-primary);
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 0.5rem;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .btn-add-offer:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
      background: #f8f9fa;
    }

    .alert {
      border-radius: 0.75rem;
      border: none;
      padding: 1rem 1.5rem;
      margin-bottom: 1.5rem;
      font-weight: 500;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    .alert-danger {
      background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
      color: #991b1b;
    }

    .alert-success {
      background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
      color: #065f46;
    }

    .table-card {
      background: white;
      border-radius: 1rem;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
      overflow: hidden;
      border: 1px solid var(--border-color);
    }

    .table {
      margin: 0;
      border: none;
    }

    .table thead {
      background: linear-gradient(135deg, var(--dark-primary) 0%, var(--dark-secondary) 100%);
    }

    .table thead th {
      color: white;
      font-weight: 600;
      text-transform: uppercase;
      font-size: 0.875rem;
      letter-spacing: 0.5px;
      padding: 1.25rem 1rem;
      border: none;
      vertical-align: middle;
    }

    .table tbody tr {
      transition: all 0.2s ease;
      border-bottom: 1px solid var(--border-color);
    }

    .table tbody tr:hover {
      background: linear-gradient(90deg, #f9fafb 0%, #f3f4f6 100%);
      transform: scale(1.005);
    }

    .table tbody tr:last-child {
      border-bottom: none;
    }

    .table tbody td {
      padding: 1.25rem 1rem;
      vertical-align: middle;
      color: var(--text-dark);
      font-weight: 500;
    }

    .offer-type-badge {
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      font-weight: 700;
      display: inline-block;
      font-size: 0.875rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .offer-type-product {
      background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
      color: #1e40af;
      box-shadow: 0 2px 8px rgba(37, 99, 235, 0.2);
    }

    .offer-type-category {
      background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
      color: #065f46;
      box-shadow: 0 2px 8px rgba(16, 185, 129, 0.2);
    }

    .applies-to-text {
      color: var(--text-dark);
      font-weight: 600;
      font-size: 0.9375rem;
    }

    .offer-value {
      background: linear-gradient(135deg, var(--dark-accent) 0%, var(--dark-secondary) 100%);
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      font-weight: 700;
      display: inline-block;
      font-size: 1rem;
      box-shadow: 0 2px 8px rgba(15, 52, 96, 0.3);
    }

    .date-badge {
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      color: #92400e;
      padding: 0.5rem 0.875rem;
      border-radius: 0.5rem;
      font-weight: 600;
      display: inline-block;
      font-size: 0.875rem;
      box-shadow: 0 2px 8px rgba(245, 158, 11, 0.2);
    }

    .btn-delete {
      background: linear-gradient(135deg, var(--accent-red) 0%, #dc2626 100%);
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      font-weight: 600;
      transition: all 0.2s ease;
      box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
    }

    .btn-delete:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
      background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
      color: white;
    }

    .empty-state {
      text-align: center;
      padding: 4rem 2rem;
    }

    .empty-state-icon {
      font-size: 4rem;
      color: var(--text-light);
      margin-bottom: 1rem;
    }

    .empty-state-text {
      color: var(--text-dark);
      font-size: 1.125rem;
      font-weight: 600;
    }

    /* SweetAlert2 Custom Styling */
    .swal2-popup {
      border-radius: 1rem;
      padding: 2rem;
    }

    .swal2-title {
      color: var(--text-dark);
      font-weight: 700;
    }

    .swal2-html-container {
      color: var(--text-dark);
    }

    .swal2-confirm {
      background: linear-gradient(135deg, var(--dark-primary) 0%, var(--dark-secondary) 100%) !important;
      border-radius: 0.5rem;
      padding: 0.75rem 1.5rem;
      font-weight: 600;
    }

    .swal2-cancel {
      background: #e5e7eb !important;
      color: var(--text-dark) !important;
      border-radius: 0.5rem;
      padding: 0.75rem 1.5rem;
      font-weight: 600;
    }

    .form-select,
    .form-control {
      border: 2px solid var(--border-color);
      border-radius: 0.5rem;
      padding: 0.75rem;
      color: var(--text-dark);
      font-weight: 500;
    }

    .form-select:focus,
    .form-control:focus {
      border-color: var(--dark-primary);
      box-shadow: 0 0 0 3px rgba(26, 26, 46, 0.1);
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .table-card {
      animation: fadeIn 0.5s ease;
    }
  </style>
</head>

<body>
  <div class="d-flex">
    <%- include('partials/sidebar') %>

    <div class="main-content">
      <%- include('partials/topBar') %>

      <div class="content-wrapper container-fluid">
        <% if (error) { %>
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
          <i class="bi bi-exclamation-triangle-fill"></i> <%= error %>
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        <% } %>

        <% if (success) { %>
        <div class="alert alert-success alert-dismissible fade show" role="alert">
          <i class="bi bi-check-circle-fill"></i> <%= success %>
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        <% } %>

        <div class="page-header">
          <h2><i class="bi bi-tag-fill"></i> Offers Management</h2>
          <button class="btn-add-offer" onclick="addOffer()">
            <i class="bi bi-plus-circle-fill"></i> Add New Offer
          </button>
        </div>

        <div class="table-card">
          <table class="table table-hover">
            <thead>
              <tr>
                <th scope="col"><i class="bi bi-bookmark-fill"></i> Type</th>
                <th scope="col"><i class="bi bi-bullseye"></i> Applies To</th>
                <th scope="col"><i class="bi bi-currency-rupee"></i> Offer Value</th>
                <th scope="col"><i class="bi bi-calendar-check"></i> Start Date</th>
                <th scope="col"><i class="bi bi-calendar-x"></i> End Date</th>
                <th scope="col"><i class="bi bi-gear-fill"></i> Actions</th>
              </tr>
            </thead>
            <tbody>
              <% if (offer && offer.length > 0) { %>
              <% offer.forEach(function(item) { %>
              <tr>
                <td>
                  <span class="offer-type-badge offer-type-<%= item.appliesTo %>">
                    <%= item.appliesTo.charAt(0).toUpperCase() + item.appliesTo.slice(1) %>
                  </span>
                </td>
                <td>
                  <span class="applies-to-text">
                    <% if (item.appliesTo === 'product') { %>
                    <% const product = products.find(p => p._id.toString() === item.productId?.toString()); %>
                    <%= product ? product.name : item.productId %>
                    <% } else { %>
                    <% const category = categories.find(c => c._id.toString() === item.categoryId?.toString()); %>
                    <%= category ? category.name : item.categoryId %>
                    <% } %>
                  </span>
                </td>
                <td>
                  <span class="offer-value">â‚¹<%= item.offerValue %></span>
                </td>
                <td>
                  <span class="date-badge">
                    <i class="bi bi-calendar-event"></i> <%= item.startDate %>
                  </span>
                </td>
                <td>
                  <span class="date-badge">
                    <i class="bi bi-calendar-event"></i> <%= item.endDate %>
                  </span>
                </td>
                <td>
                  <button class="btn btn-delete" onclick="deleteOffer('<%= item._id %>')">
                    <i class="bi bi-trash-fill"></i> Delete
                  </button>
                </td>
              </tr>
              <% }) %>
              <% } else { %>
              <tr>
                <td colspan="6">
                  <div class="empty-state">
                    <div class="empty-state-icon">
                      <i class="bi bi-inbox"></i>
                    </div>
                    <p class="empty-state-text">No offers available yet. Create your first offer to get started!</p>
                  </div>
                </td>
              </tr>
              <% } %>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script>
    // DELETE
    async function deleteOffer(offerId) {
      Swal.fire({
        title: 'Are you sure?',
        text: "This offer will be disabled.",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#1a1a2e',
        cancelButtonColor: '#6b7280',
        confirmButtonText: 'Yes, delete it!',
        cancelButtonText: 'Cancel'
      }).then(async (result) => {
        if (result.isConfirmed) {
          try {
            await axios.put(`/admin/offers/${offerId}`, { Active: false });
            Swal.fire({
              title: 'Deleted!',
              text: 'The offer has been deleted.',
              icon: 'success',
              timer: 1500,
              showConfirmButton: false
            }).then(() => {
              window.location.reload();
            });
          } catch (error) {
            Swal.fire({
              title: 'Error!',
              text: error.response?.data?.errors?.join(', ') || error.response?.data?.message || 'Failed to delete offer',
              icon: 'error',
              confirmButtonText: 'OK',
              confirmButtonColor: '#1a1a2e'
            });
          }
        }
      });
    }

    // ADD with dropdowns
    async function addOffer() {
      const { value: formValues } = await Swal.fire({
        title: 'Add New Offer',
        html: `
          <select id="appliesTo" class="form-select mb-2" onchange="toggleTargetDropdown(this.value)">
            <option value="product">Product</option>
            <option value="category">Category</option>
          </select>

          <select id="productDropdown" class="form-select mb-2">
            <option value="">-- Select Product --</option>
            <% products.forEach(p => { %>
              <option value="<%= p._id %>"><%= p.name %></option>
            <% }) %>
          </select>

          <select id="categoryDropdown" class="form-select mb-2" style="display:none;">
            <option value="">-- Select Category --</option>
            <% categories.forEach(c => { %>
              <option value="<%= c._id %>"><%= c.name %></option>
            <% }) %>
          </select>

          <input id="offerValue" type="number" class="form-control mb-2" placeholder="Offer Value (â‚¹)">
          <input id="startDate" type="date" class="form-control mb-2">
          <input id="endDate" type="date" class="form-control mb-2">
        `,
        focusConfirm: false,
        showCancelButton: true,
        confirmButtonText: 'Save Offer',
        cancelButtonText: 'Cancel',
        confirmButtonColor: '#1a1a2e',
        cancelButtonColor: '#6b7280',
        preConfirm: () => {
          const appliesTo = document.getElementById('appliesTo').value;
          const productId = document.getElementById('productDropdown').value;
          const categoryId = document.getElementById('categoryDropdown').value;
          const offerValue = document.getElementById('offerValue').value;
          const startDate = document.getElementById('startDate').value;
          const endDate = document.getElementById('endDate').value;

          if (appliesTo === 'product' && !productId) {
            Swal.showValidationMessage('Please select a product');
            return false;
          }
          if (appliesTo === 'category' && !categoryId) {
            Swal.showValidationMessage('Please select a category');
            return false;
          }

          let payload = { appliesTo};
          if (appliesTo === 'product') payload.productId = productId;
          if (appliesTo === 'category') payload.categoryId = categoryId;
          if (offerValue) payload.offerValue = offerValue;
          if (startDate) payload.startDate = startDate;
          if (endDate) payload.endDate = endDate;

          return payload;
        }
      });

      if (formValues) {
        try {
          await axios.post('/admin/offers/add', formValues);
          Swal.fire({
            icon: 'success',
            title: 'Offer Added!',
            showConfirmButton: false,
            timer: 1500
          }).then(() => window.location.reload());
        } catch (error) {
          Swal.fire({
            icon: 'error',
            title: 'Error!',
            text: error.response?.data?.errors?.join(', ') || error.response?.data?.message || 'Failed to add offer',
            confirmButtonColor: '#1a1a2e'
          });
        }
      }
    }

    // toggle dropdowns
    function toggleTargetDropdown(value) {
      document.getElementById('productDropdown').style.display = value === 'product' ? 'block' : 'none';
      document.getElementById('categoryDropdown').style.display = value === 'category' ? 'block' : 'none';
    }
  </script>
</body>

</html>